/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{CanvasElement as c,CHART_UUID as B,DEFAULT_BOUNDS as w}from"../../../canvas/canvas-bounds-container";import{drawRoundedRect as D,avoidAntialiasing as S}from"../../../utils/canvas-drawing-functions.utils";import{priceLabelDrawersMap as M}from"../../y_axis/price_labels/price-label.drawer";export class CrossAndLabelsDrawerType{constructor(o,s,n,a,e=()=>!0){this.config=o,this.canvasBoundsContainer=s,this.chartModel=n,this.paneManager=a,this.crossDrawPredicate=e}draw(o,s){this.crossDrawPredicate()&&(S(o,()=>this.drawCrossTool(o,s)),this.drawXLabel(o,s),this.drawYLabel(o,s))}drawCrossTool(o,s){var n,a,e,l;const t=this.canvasBoundsContainer.getBounds(c.ALL_PANES),i=this.canvasBoundsContainer.getBoundsHitTest(c.ALL_PANES,{extensionY:1e-4}),r=(n=this.config.components.xAxis.padding.top)!==null&&n!==void 0?n:0,d=(e=this.config.components.yAxis.typeConfig[(a=this.config.components.crossTool.yLabel.type)!==null&&a!==void 0?a:"badge"])===null||e===void 0?void 0:e.paddings,h=(l=d==null?void 0:d.start)!==null&&l!==void 0?l:0;if(i(s.x,t.y)){const g={start:[t.x,s.y],end:[t.x+t.width+h,s.y]},p={start:[s.x,t.y],end:[s.x,t.y+t.height+r]};o.strokeStyle=this.config.colors.crossTool.lineColor,o.setLineDash(this.config.components.crossTool.lineDash),o.beginPath(),i(s.x,s.y)&&(o.moveTo(...g.start),o.lineTo(...g.end)),o.moveTo(...p.start),o.lineTo(...p.end),o.stroke()}}drawXLabel(o,s){var n,a,e,l,t;const i=this.config.components.crossTool.xLabel.padding,r=this.config.components.crossTool.xLabel.margin,d=this.config.colors.crossTool;if(this.config.components.xAxis.visible){o.font=this.config.components.xAxis.fontSize+"px "+this.config.components.xAxis.fontFamily;const h=s.x,g=s.time,p=o.measureText(g).width,u=this.config.components.xAxis.fontSize,f=this.canvasBoundsContainer.getBounds(c.X_AXIS);o.save(),o.fillStyle=d.labelBoxColor;const x=(n=i==null?void 0:i.left)!==null&&n!==void 0?n:0,T=(a=i==null?void 0:i.right)!==null&&a!==void 0?a:0,b=(e=i==null?void 0:i.top)!==null&&e!==void 0?e:0,y=(l=i==null?void 0:i.bottom)!==null&&l!==void 0?l:0,v=(t=r==null?void 0:r.top)!==null&&t!==void 0?t:0,m=p+x+T,L=u+b+y,A=Math.max(h-m/2,0),C=f.y+v;D(o,A,C,m,L),o.fillStyle=d.labelTextColor;const P=Math.max(h-p/2,x),_=f.y+v+u+b-1;o.fillText(g,P,_),o.restore()}}drawYLabel(o,s){const n=this.config.components.crossTool.yLabel.padding,a=this.config.colors.crossTool;if(this.config.components.yAxis.visible){const e=this.getPaneIfHit(s),l=s.y;let t="",i=w;if(e){const d=e.regularValueFromY(l);t=e.valueFormatter(d),i=this.canvasBoundsContainer.getBounds(c.PANE_UUID_Y_AXIS(e.uuid))}else t=this.chartModel.pane.valueFormatter(this.chartModel.priceFromY(l)),i=this.canvasBoundsContainer.getBounds(c.PANE_UUID_Y_AXIS(B));const r=M[this.config.components.crossTool.yLabel.type];r(o,i,t,l,{textColor:a.labelTextColor,bgColor:a.labelBoxColor,paddingBottom:n==null?void 0:n.bottom,paddingEnd:n==null?void 0:n.end,paddingTop:n==null?void 0:n.top},this.config.components.yAxis,this.config.colors.yAxis)}}getPaneIfHit(o){return Object.values(this.paneManager.paneComponents).find(n=>this.canvasBoundsContainer.getBoundsHitTest(c.PANE_UUID(n.uuid))(o.x,o.y))}}
