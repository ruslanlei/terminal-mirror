/** Copyright Â©2023 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const _0x1678e7=(function(){let _0x32ceba=!![];return function(_0x1f1db8,_0x763b88){const _0x1496f9=_0x32ceba?function(){if(_0x763b88){const _0x13f059=_0x763b88['apply'](_0x1f1db8,arguments);return _0x763b88=null,_0x13f059;}}:function(){};return _0x32ceba=![],_0x1496f9;};}()),_0x15b32a=_0x1678e7(this,function(){const _0x2858fb=function(){let _0x589e59;try{_0x589e59=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x4b8e81){_0x589e59=window;}return _0x589e59;},_0x2c1d3c=_0x2858fb(),_0x1c6cba=new RegExp('[GFbqAALJklCaBCVBXNgGywyhaJLbwqfynX]','g'),_0x8ecd00='GF.bqdAALJkelveCxpeartBs.CVBcoXNgmGywyhaJLbwqfynX'['replace'](_0x1c6cba,'')['split'](';');let _0x11ed0d,_0x29ace7,_0x25cf2d,_0x4ca6c4;const _0x159c39=function(_0x43be41,_0x1e02fb,_0x576a29){if(_0x43be41['length']!=_0x1e02fb)return![];for(let _0x204b3e=0x0;_0x204b3e<_0x1e02fb;_0x204b3e++){for(let _0x27c9d1=0x0;_0x27c9d1<_0x576a29['length'];_0x27c9d1+=0x2){if(_0x204b3e==_0x576a29[_0x27c9d1]&&_0x43be41['charCodeAt'](_0x204b3e)!=_0x576a29[_0x27c9d1+0x1])return![];}}return!![];},_0x364c0a=function(_0x536cad,_0x132cf4,_0x1087b2){return _0x159c39(_0x132cf4,_0x1087b2,_0x536cad);},_0x5df3b2=function(_0x319d56,_0x4d1531,_0x428c17){return _0x364c0a(_0x4d1531,_0x319d56,_0x428c17);},_0x46a48b=function(_0x5c85c4,_0x3cb0eb,_0x5822ea){return _0x5df3b2(_0x3cb0eb,_0x5822ea,_0x5c85c4);};for(let _0x4653fa in _0x2c1d3c){if(_0x159c39(_0x4653fa,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){_0x11ed0d=_0x4653fa;break;}}for(let _0x140080 in _0x2c1d3c[_0x11ed0d]){if(_0x46a48b(0x6,_0x140080,[0x5,0x6e,0x0,0x64])){_0x29ace7=_0x140080;break;}}for(let _0x204813 in _0x2c1d3c[_0x11ed0d]){if(_0x5df3b2(_0x204813,[0x7,0x6e,0x0,0x6c],0x8)){_0x25cf2d=_0x204813;break;}}if(!('~'>_0x29ace7))for(let _0x4c8ff2 in _0x2c1d3c[_0x11ed0d][_0x25cf2d]){if(_0x364c0a([0x7,0x65,0x0,0x68],_0x4c8ff2,0x8)){_0x4ca6c4=_0x4c8ff2;break;}}if(!_0x11ed0d||!_0x2c1d3c[_0x11ed0d])return;const _0x2a99e2=_0x2c1d3c[_0x11ed0d][_0x29ace7],_0x30f4bf=!!_0x2c1d3c[_0x11ed0d][_0x25cf2d]&&_0x2c1d3c[_0x11ed0d][_0x25cf2d][_0x4ca6c4],_0x59b1ac=_0x2a99e2||_0x30f4bf;if(!_0x59b1ac)return;let _0x11ea69=Date['now']()<0x1902dcb0c00;for(let _0x1f0cb3=0x0;_0x1f0cb3<_0x8ecd00['length'];_0x1f0cb3++){const _0x1b6615=_0x8ecd00[_0x1f0cb3],_0x3bea7c=_0x1b6615[0x0]===String['fromCharCode'](0x2e)?_0x1b6615['slice'](0x1):_0x1b6615,_0xae1250=_0x59b1ac['length']-_0x3bea7c['length'],_0x31713c=_0x59b1ac['indexOf'](_0x3bea7c,_0xae1250),_0x518280=_0x31713c!==-0x1&&_0x31713c===_0xae1250;_0x518280&&((_0x59b1ac['length']==_0x1b6615['length']||_0x1b6615['indexOf']('.')===0x0)&&(_0x11ea69=!![]));}if(!_0x11ea69){const _0x487666=new RegExp('[nbFgIkSHMLyIyWfQXWMfEijCKgTEFMTGDJFfNwYEiKqXqwDIPKTAnUiBRlBIYzUwb]','g'),_0x30ead7='htntpbs:Fg/I/kSHMdevLyIeyWxpfertsQXW.McofmE/dxichajrtCsKgTE/FMTGDJFfNwYEiKqXqwDIPKTAnUiBRlBIYzUwb'['replace'](_0x487666,'');_0x2c1d3c[_0x11ed0d][_0x25cf2d]=_0x30ead7;}});_0x15b32a();import{uuid}from'@dx-private/dxchart5-light/dist/chart/utils/uuid.utils';import{array,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{combineLatest,EMPTY,from,merge,of}from'rxjs';import{debounceTime,map,switchMap,tap}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{isSuccessCompile}from'../../providers/dx-script-provider';import{createAdapter}from'../../utils/adapter.utils';import{ColorsPool}from'../../utils/colorspool/ColorsPool';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{mapScript2StudySettings,mapScriptLines,mapScriptParams}from'../model/dxscript.model';import{sortStudies}from'../model/studies.model';export const createDxScriptEditViewModel=context['combine'](context['key']()('multiChartViewModel'),context['key']()('dxStudiesProvider'),context['key']()('dxScriptProvider'),context['key']()('dxScriptRunner'),context['key']()('localization'),context['key']()('initialDxScripts'),context['key']()('dxScriptKeywords'),(_0x2b8005,_0x286ce8,_0x5d89bd,_0x2b9012,_0x255e1e,_0x315e84,_0x11699c)=>{const _0x128a1e=getEmtptyErrorCode(_0x255e1e),[_0x400fd7,_0x107ac0]=createAdapter(),[_0x32b08b,_0x84c892]=createAdapter(),[_0x1f68cb,_0x495c30]=createAdapter(),[_0x43b8cd,_0x47d717]=createAdapter(),_0x220ffd=new ColorsPool(['red','blue','green','orange','teal'],'grey','locked'),[_0x17d913,_0x144ed6]=createPropertyAdapter(_0x315e84['map'](scriptToPopupState)),_0x259ad8=_0x5475c1=>_0x17d913(updatePopupsOrder(_0x5475c1)),_0x14cc15=_0x206dc0=>_0x259ad8([..._0x144ed6['getValue'](),scriptToPopupState(_0x206dc0)]),_0x4d2137=_0x2a704e=>_0x259ad8([..._0x144ed6['getValue']()['filter'](_0x106bb8=>_0x106bb8['dxScript']['id']!==_0x2a704e)]),_0x166a9d=(_0x24b9c8,_0x283ccd)=>pipe(_0x144ed6['getValue'](),array['map'](_0x5797f6=>_0x5797f6['dxScript']['id']===_0x24b9c8?{..._0x5797f6,..._0x283ccd(_0x5797f6)}:_0x5797f6),_0x259ad8,()=>_0x144ed6['getValue']()['find'](_0x2fd4c1=>_0x2fd4c1['dxScript']['id']===_0x24b9c8),option['fromNullable']),_0x5c75ed=_0x52b81f=>pipe(_0x5d89bd['getScript'](_0x52b81f)['then'](_0x135fb8=>_0x166a9d(_0x52b81f,_0x1ee7ef=>({'opened':!![],'dxScript':{..._0x1ee7ef['dxScript'],..._0x135fb8},'addButtonDisabled':isCodeEmpty(_0x135fb8?.['code'])})))),_0x3448ea=_0x445ee4=>pipe(_0x166a9d(_0x445ee4,()=>({'popupOrder':0x0,'opened':![]})),option['fold'](constVoid,_0x10f9a1=>_0x5d89bd['updateScript'](_0x10f9a1['dxScript']))),_0x2c06bc=(_0x3be346,_0x15257b)=>_0x166a9d(_0x3be346,()=>({'isAutoSaving':_0x15257b})),_0x3a84df=_0x4700b6=>_0x166a9d(_0x4700b6,()=>({'addedOnChart':![]})),_0x3d0b8a=_0x1bc0f9=>pipe(_0x166a9d(_0x1bc0f9,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,_0x4acd19=>_0x400fd7(_0x4acd19['dxScript']))),_0xcabc23=_0x3565ef=>pipe(_0x166a9d(_0x3565ef,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,_0x242500=>_0x32b08b(_0x242500['dxScript']))),_0x4521ff=_0xc92e46=>pipe(_0x166a9d(_0xc92e46['id'],_0x259138=>({'updateButtonDisabled':![],'dxScript':{..._0x259138['dxScript'],'name':_0xc92e46['name'],'code':_0xc92e46['code']},'addButtonDisabled':isCodeEmpty(_0xc92e46['code'])})),option['fold'](constVoid,_0x365c79=>_0x1f68cb(_0x365c79['dxScript']))),_0x993a81=_0x26353a=>_0x166a9d(_0x26353a,_0x89945a=>({..._0x89945a,'addedOnChart':!![],'isCompiling':![],'dxScript':{..._0x89945a['dxScript'],'errors':[]}})),_0x4d4e65=(_0x3dbdff,_0x7e5c69)=>{const _0x3e60f0={'name':findSuitableName(_0x3dbdff,_0x144ed6['getValue']()),'code':_0x7e5c69,'locked':![]};_0x5d89bd['createScript'](_0x3e60f0)['then'](_0x19405d=>{const _0x1427c9={..._0x3e60f0};_0x1427c9['id']=_0x19405d,_0x14cc15(_0x1427c9),_0x5c75ed(_0x19405d);});},_0x305a91=()=>_0x4d4e65(_0x255e1e['studiesPopup']['newScript'],''),_0x158e91=_0x487e0c=>_0x4d4e65(_0x487e0c['name'],_0x487e0c['code']),_0xa56c2d=_0x13da10=>pipe(from([_0x13da10]),observable['chain'](_0x510c51=>from(((async()=>[_0x510c51,await _0x2b9012['compileScript'](_0x510c51['code'])])()))),observable['map'](([_0x6bd056,_0x582646])=>{if(!_0x6bd056||isCodeEmpty(_0x6bd056['code']))return _0x43b8cd([_0x6bd056['id'],[_0x128a1e]]),undefined;const _0x1d2084=_0x582646;if(isSuccessCompile(_0x1d2084))return _0x1d2084;return _0x1d2084['scriptErrors']&&_0x43b8cd([_0x6bd056['id'],_0x1d2084['scriptErrors']]),undefined;})),_0x43c4ab=_0x4faf28=>pipe(from(_0x5d89bd['getScript'](_0x4faf28['id'])),observable['filterMap'](_0x4f229d=>_0x4f229d?option['some'](_0x4f229d):option['none']),observable['chain'](_0xa56c2d),observable['map'](_0x2a26f0=>pipe(_0x2a26f0,option['fromNullable'],option['chain'](option['fromPredicate'](isSuccessCompile)),option['map'](_0xf21210=>{return _0x4faf28['parameters']=mapScriptParams(_0x4faf28,_0xf21210),_0x4faf28['lines']=mapScriptLines(_0x4faf28,_0xf21210,_0x220ffd),_0x286ce8['updateStudy'](_0x4faf28),{..._0x4faf28,'uuid':uuid()};})))),_0x48af52=_0x264b2d=>{_0x5d89bd['deleteScript'](_0x264b2d),_0x286ce8['setStudies'](_0x286ce8['getStudies']()['filter'](_0x58e43f=>_0x58e43f['id']!==_0x264b2d)),_0x4d2137(_0x264b2d);},_0x22858a=_0x5dd498=>pipe(_0x5dd498,option['fromPredicate'](_0x8ce593=>_0x8ce593['locked']===![]),option['fold'](()=>of(_0x5dd498),()=>pipe(from(_0x5d89bd['updateScript']({'id':_0x5dd498['id'],'code':_0x5dd498['code'],'name':_0x5dd498['name'],'locked':![]})),switchMap(()=>of(_0x5dd498))))),_0x573ab1=pipe(_0x84c892,switchMap(_0x22858a)),_0x396d33=pipe(_0x107ac0,switchMap(_0x22858a)),_0xb06169=_0x2b8005['selectedChartId']['pipe'](map(()=>_0x2b8005['getSelectedChartInfo']()),tap(_0x3589fc=>pipe(_0x144ed6['getValue'](),array['map'](_0x15b295=>_0x3589fc['studies']['find'](_0x2f0bf3=>_0x2f0bf3['id']===_0x15b295['dxScript']['id'])?{..._0x15b295,'addedOnChart':!![]}:{..._0x15b295,'addedOnChart':![]}),_0x259ad8))),_0x1e7a8f=_0x144ed6['pipe'](tap(_0x348986=>{const _0x1e6155=_0x286ce8['getStudies']()['filter'](_0x2dab5b=>_0x2dab5b['type']!=='dxScript'),_0x19f4db=_0x348986['map'](_0x57ae30=>mapScript2StudySettings(_0x57ae30['dxScript'],_0x286ce8['getStudy'](_0x57ae30['dxScript']['id'])));_0x286ce8['setStudies'](sortStudies([..._0x1e6155,..._0x19f4db]));})),_0x157106=pipe(_0x495c30,debounceTime(0x7d0),switchMap(_0x37e5da=>{_0x2c06bc(_0x37e5da['id'],!![]);const _0x5c4005={};return _0x5c4005['id']=_0x37e5da['id'],_0x5c4005['code']=_0x37e5da['code'],_0x5c4005['name']=_0x37e5da['name'],_0x5c4005['locked']=![],from(_0x5d89bd['updateScript'](_0x5c4005)['then'](()=>_0x37e5da['id']));}),tap(_0x458274=>_0x2c06bc(_0x458274,![]))),_0x13f220=pipe(_0x47d717,map(([_0x4dcb9b,_0x2df166])=>_0x166a9d(_0x4dcb9b,_0xd89a72=>({..._0xd89a72,'popupOrder':0x0,'opened':!![],'dxScript':{..._0xd89a72['dxScript'],'errors':_0x2df166},'addButtonDisabled':isCodeEmpty(_0xd89a72['dxScript']['code']),'addedOnChart':![],'isCompiling':![],'updateButtonDisabled':!![],'isAutoSaving':![]}))));pipe(_0x2b8005['getAllCharts'](),array['chain'](_0x9be868=>_0x9be868['studies']),_0x208816=>combineLatest([_0x208816['map'](_0x3efb7c=>{const _0x5cb878=_0x286ce8['getStudy'](_0x3efb7c['id']);if(_0x5cb878&&_0x5cb878['type']==='dxScript')return _0x43c4ab(_0x5cb878);return EMPTY;})]),_0x48f4ca=>_0x48f4ca['subscribe']());const _0x18b229=merge(_0x1e7a8f,_0x157106,_0x13f220,_0xb06169),_0x186b78={};return _0x186b78['lastAddedScript']=_0x396d33,_0x186b78['lastUpdatedScript']=_0x573ab1,_0x186b78['popups']=_0x144ed6,_0x186b78['addNewScript']=_0x305a91,_0x186b78['duplicateScript']=_0x158e91,_0x186b78['onPopupOpen']=_0x5c75ed,_0x186b78['onPopupClose']=_0x3448ea,_0x186b78['onScriptEdit']=_0x4521ff,_0x186b78['onAddedOnChart']=_0x993a81,_0x186b78['deleteScript']=_0x48af52,_0x186b78['addToChart']=_0x3d0b8a,_0x186b78['updateScriptOnChart']=_0xcabc23,_0x186b78['removeFromChart']=_0x3a84df,_0x186b78['compileScriptStudy']=_0x43c4ab,_0x186b78['keywords']=_0x11699c,newSink(callTracerProxy('dxScriptEditViewModel',_0x186b78),_0x18b229);});const findSuitableName=(_0x5a784a,_0x23ec94,_0x108df3=0x2)=>{if(!_0x23ec94['find'](_0x504e7b=>_0x504e7b['dxScript']['name']===_0x5a784a))return _0x5a784a;if(_0x23ec94['find'](_0x491f2d=>_0x491f2d['dxScript']['name']===formatName(_0x5a784a)+'\x20('+_0x108df3+')'))return findSuitableName(_0x5a784a,_0x23ec94,_0x108df3+0x1);return formatName(_0x5a784a)+'\x20('+_0x108df3+')';},formatName=_0x4004cb=>{const _0x1082c5=new RegExp(/(\(\d+\))$/g),_0x3991a1=_0x1082c5['exec'](_0x4004cb);return _0x3991a1&&(_0x4004cb=_0x4004cb['substring'](0x0,_0x3991a1['index']-0x1)),_0x4004cb;},updatePopupsOrder=_0x1407ee=>{let _0x50276b=0x0;return _0x1407ee['forEach'](_0x240c81=>{_0x50276b=Math['max'](_0x50276b,_0x240c81['popupOrder']);}),_0x1407ee['map'](_0x1809d6=>{if(_0x1809d6['opened']){const _0x2a8d99={..._0x1809d6};return _0x2a8d99['popupOrder']=_0x1809d6['popupOrder']===0x0?++_0x50276b:_0x1809d6['popupOrder'],_0x2a8d99;}else{const _0x5310bd={..._0x1809d6};return _0x5310bd['popupOrder']=0x0,_0x5310bd;}});},isCodeEmpty=_0x1852f8=>_0x1852f8===undefined||_0x1852f8['trim']()['length']===0x0,_0x1039cc={};_0x1039cc['beginChar']=0x0,_0x1039cc['beginLine']=0x0,_0x1039cc['endChar']=0x0,_0x1039cc['endLine']=0x0;const _0x404796={};_0x404796['sourceCodeId']='0',_0x404796['bounds']=_0x1039cc;const getEmtptyErrorCode=_0x1a417e=>({'message':_0x1a417e['codeEditor']['errors']['emptyCode'],'region':_0x404796}),scriptToPopupState=_0x2ffbe4=>({'dxScript':{..._0x2ffbe4,'errors':[]},'isCompiling':![],'addedOnChart':![],'opened':![],'popupOrder':0x0,'addButtonDisabled':isCodeEmpty(_0x2ffbe4['code']),'updateButtonDisabled':!![],'isAutoSaving':![]});