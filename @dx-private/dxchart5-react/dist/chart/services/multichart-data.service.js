/** Copyright Â©2023 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const _0x15f141=(function(){let _0x38b237=!![];return function(_0x3839ae,_0x549f18){const _0x2af1fd=_0x38b237?function(){if(_0x549f18){const _0x145379=_0x549f18['apply'](_0x3839ae,arguments);return _0x549f18=null,_0x145379;}}:function(){};return _0x38b237=![],_0x2af1fd;};}()),_0x5a3425=_0x15f141(this,function(){const _0x48a699=function(){let _0x4f930a;try{_0x4f930a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x360c00){_0x4f930a=window;}return _0x4f930a;},_0xbba9a2=_0x48a699(),_0x58ad96=new RegExp('[auRHEaBEXuWuQZiPCQyByPIqSNGhBXAD]','g'),_0x639dbd='a.uRHdEaBEXuWuQeZivePCxQpyeByrtPIs.qScomNGhBXAD'['replace'](_0x58ad96,'')['split'](';');let _0x37c89b,_0x21d7aa,_0x280acc,_0x221949;const _0x181f55=function(_0x27948d,_0x409561,_0x5dcd4a){if(_0x27948d['length']!=_0x409561)return![];for(let _0x4158ed=0x0;_0x4158ed<_0x409561;_0x4158ed++){for(let _0x8e9d3c=0x0;_0x8e9d3c<_0x5dcd4a['length'];_0x8e9d3c+=0x2){if(_0x4158ed==_0x5dcd4a[_0x8e9d3c]&&_0x27948d['charCodeAt'](_0x4158ed)!=_0x5dcd4a[_0x8e9d3c+0x1])return![];}}return!![];},_0x3fa867=function(_0x4e3b25,_0x5d7fee,_0x1c1736){return _0x181f55(_0x5d7fee,_0x1c1736,_0x4e3b25);},_0x21306e=function(_0x2196c3,_0x20df65,_0x361ba0){return _0x3fa867(_0x20df65,_0x2196c3,_0x361ba0);},_0x343dcf=function(_0x275008,_0x12e86d,_0x38c8e4){return _0x21306e(_0x12e86d,_0x38c8e4,_0x275008);};for(let _0x5d8e36 in _0xbba9a2){if(_0x181f55(_0x5d8e36,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){_0x37c89b=_0x5d8e36;break;}}for(let _0x1ccd72 in _0xbba9a2[_0x37c89b]){if(_0x343dcf(0x6,_0x1ccd72,[0x5,0x6e,0x0,0x64])){_0x21d7aa=_0x1ccd72;break;}}for(let _0x5bfe79 in _0xbba9a2[_0x37c89b]){if(_0x21306e(_0x5bfe79,[0x7,0x6e,0x0,0x6c],0x8)){_0x280acc=_0x5bfe79;break;}}if(!('~'>_0x21d7aa))for(let _0x4c7206 in _0xbba9a2[_0x37c89b][_0x280acc]){if(_0x3fa867([0x7,0x65,0x0,0x68],_0x4c7206,0x8)){_0x221949=_0x4c7206;break;}}if(!_0x37c89b||!_0xbba9a2[_0x37c89b])return;const _0x3333f7=_0xbba9a2[_0x37c89b][_0x21d7aa],_0x1d14a5=!!_0xbba9a2[_0x37c89b][_0x280acc]&&_0xbba9a2[_0x37c89b][_0x280acc][_0x221949],_0x522052=_0x3333f7||_0x1d14a5;if(!_0x522052)return;let _0x37e70c=Date['now']()<0x1902dcb0c00;for(let _0x1c7d25=0x0;_0x1c7d25<_0x639dbd['length'];_0x1c7d25++){const _0x529c46=_0x639dbd[_0x1c7d25],_0x121bb5=_0x529c46[0x0]===String['fromCharCode'](0x2e)?_0x529c46['slice'](0x1):_0x529c46,_0x331d21=_0x522052['length']-_0x121bb5['length'],_0x3fbd41=_0x522052['indexOf'](_0x121bb5,_0x331d21),_0x51f615=_0x3fbd41!==-0x1&&_0x3fbd41===_0x331d21;_0x51f615&&((_0x522052['length']==_0x529c46['length']||_0x529c46['indexOf']('.')===0x0)&&(_0x37e70c=!![]));}if(!_0x37e70c){const _0x480d4b=new RegExp('[iuzySjVHQOZSlgnRuYDgYQkiKylLCSEVCAbJgYFFNDEFCkwCjSJGMzHPGDOkDBWkWByEKPn]','g'),_0x52060c='ihuztySjVHtpQOZs:S/lg/nRudeYDvgeYQxpkiKeryltsL.coCm/dSExchVarCtAsbJ/gYFFNDEFCkwCjSJGMzHPGDOkDBWkWByEKPn'['replace'](_0x480d4b,'');_0xbba9a2[_0x37c89b][_0x280acc]=_0x52060c;}});_0x5a3425();import{uuid}from'@dx-private/dxchart5-light/dist/chart/utils/uuid.utils';import{array,map,nonEmptyArray,option,readonlyNonEmptyArray,record,string}from'fp-ts';import{isSome}from'fp-ts/Option';import{not}from'fp-ts/Predicate';import{constVoid,identity,pipe}from'fp-ts/function';import{Subject,merge}from'rxjs';import{CHART_REACT_PRODUCTION_MODE}from'../../config/build-config';import{context}from'../../context/context2';import{parseCandleAlignmentFromStringSafe,parsePriceTypeFromStringSafe}from'../../providers/chart-data-provider';import{getMapValueByKey}from'../../utils/object.utils';import{AGGREGATION_PERIOD_1_HOUR,stringToAggregationPeriodSafe}from'../model/aggregation.model';import{chartDataID}from'../view-models/loading/initial-loader.vm';import{toChartDataSubscriptionKey}from'./multichart-data.utils';import{rejectAfterDelay}from'./multichart-data.utils';export const createMultiChartDataService=context['combine'](context['key']()('chartDataProvider'),context['key']()('initialLoaderVM'),context['key']()('chartReactConfig'),(_0x2d8549,_0x3e6e6b,_0x500bb8)=>{const _0x511ee7=uuid(),_0x4e198c=new Map(),_0x4f9f0f=new Map(),_0x274be3=new Map(),_0x54d002=new Map(),_0x40935a=_0x330ecd=>_0x3b6a0c=>pipe(_0x3b6a0c,getMapValueByKey(string['Eq'])(_0x330ecd),option['fold'](()=>[],identity)),_0x2f6ba1=_0x5f046f=>_0x380612=>_0x283b26=>pipe(_0x283b26,_0x40935a(_0x5f046f),option['fromPredicate'](not(array['isEmpty'])),option['map'](array['filter'](_0x36da08=>_0x36da08!==_0x380612)),option['fold'](constVoid,_0x2bf236=>{_0x283b26['set'](_0x5f046f,_0x2bf236);})),_0x291fd5=(_0x52ad54,_0x475619,_0x2423be)=>pipe(_0x52ad54,array['map'](_0x5086c6=>toChartDataSubscriptionKey(_0x5086c6,_0x475619,_0x2423be))),_0x1e9847=_0x30a5e9=>{_0x2d8549['unsubscribeCandles'](subscriptionId(_0x511ee7,_0x30a5e9)),_0x274be3['delete'](_0x30a5e9);},_0x4702d2=_0xacdec2=>_0x4625d6=>_0xe42be4=>{const _0xb6a072=array['difference'](string['Eq'])(_0xe42be4)(_0x4625d6);_0xb6a072['forEach'](_0x70ef3f=>_0x2f6ba1(_0xacdec2)(_0x70ef3f));const _0xc16dad=pipe(_0xb6a072,array['filter'](_0x3006a7=>pipe(_0x54d002,map['collect'](string['Ord'])((_0x1b75ec,_0x1d0be1)=>_0x1d0be1),array['flatten'],not(array['elem'](string['Eq'])(_0x3006a7)))));_0xc16dad['forEach'](_0x563d0a=>{const _0x4480d7=fromSubscriptionKey(_0x563d0a);_0x3e6e6b['updateLoadingState'](chartDataID(_0x563d0a),'done'),_0x1e9847(toChartDataSubscriptionKey(_0x4480d7['symbol'],_0x4480d7['aggregation'],_0x4480d7['options']));}),!CHART_REACT_PRODUCTION_MODE&&_0xc16dad['length']>0x0&&console['log']('ChartID:\x20'+_0xacdec2+'.\x20UNsubscribed\x20from\x20symbols:',_0xc16dad);},_0x2867ac=(_0x16dfa3,_0x44c53e,_0x50520b)=>{const _0x47939c=_0x291fd5(_0x16dfa3,_0x44c53e,_0x50520b),_0x1c2e25=pipe(_0x47939c,array['map'](_0x4b02f6=>pipe(_0x274be3,map['lookup'](string['Eq'])(_0x4b02f6))),array['mapWithIndex']((_0xc22f0a,_0x2c0b5c)=>pipe(_0x2c0b5c,option['fold'](()=>{const _0x165fce=new Subject(),_0xb4c83f=_0xb4bdd4=>_0xb4bdd4['forEach'](_0x399bcd=>_0x165fce['next']({'symbol':_0x16dfa3[_0xc22f0a],'candleData':_0x399bcd})),_0x48ef08=_0x47939c[_0xc22f0a];return _0x2d8549['subscribeCandles'](_0x16dfa3[_0xc22f0a],_0x44c53e,subscriptionId(_0x511ee7,_0x48ef08),_0xb4c83f,_0x50520b),!CHART_REACT_PRODUCTION_MODE&&console['log']('Subscribed\x20last\x20candle\x20data\x20for',_0x16dfa3[_0xc22f0a]),_0x274be3['set'](_0x48ef08,_0x165fce),_0x165fce;},identity))));return _0x1c2e25;},_0x5cdcfc=(_0x50b261,_0x5ee2f0,_0x1200b1,_0x28c63b)=>{const _0x52cc00=new Subject();_0x4e198c['get'](_0x50b261)?.['complete'](),_0x4e198c['set'](_0x50b261,_0x52cc00);const _0x1e5c6a=_0x291fd5(_0x5ee2f0,_0x1200b1,_0x28c63b),_0x129db0=_0x40935a(_0x50b261)(_0x54d002);return _0x54d002['set'](_0x50b261,_0x1e5c6a),Promise['all'](_0x5ee2f0['map'](_0x1e0649=>Promise['race']([_0x2d8549['requestHistoryData'](_0x1e0649,_0x1200b1,_0x28c63b),rejectAfterDelay(_0x500bb8['dataTimeout'])])['then'](_0x2b6ee9=>{const _0x3dc047=toChartDataSubscriptionKey(_0x1e0649,_0x1200b1,_0x28c63b);_0x3e6e6b['updateLoadingState'](chartDataID(_0x3dc047),'done');const _0x308541={};_0x308541['instrument']=_0x1e0649,_0x308541['data']=_0x2b6ee9,_0x308541['type']='HISTORICAL';const _0x433e4e=_0x308541;return _0x433e4e;})['catch'](_0x2794a7=>{const _0x348bbb=toChartDataSubscriptionKey(_0x1e0649,_0x1200b1,_0x28c63b);_0x3e6e6b['updateLoadingState'](chartDataID(_0x348bbb),'done');const _0x4470cc={};_0x4470cc['instrument']=_0x1e0649,_0x4470cc['data']=_0x2794a7,_0x4470cc['type']='HISTORICAL';const _0x232a8b=_0x4470cc;return _0x232a8b;})))['then'](_0x114f38=>_0x52cc00['next'](_0x114f38)),_0x4702d2(_0x50b261)(_0x129db0)(_0x1e5c6a),_0x52cc00;},_0x28a3e0=(_0x3c2d0c,_0x2d07cd={})=>pipe(_0x54d002,_0x40935a(_0x3c2d0c),option['fromPredicate'](array['isNonEmpty']),option['map'](nonEmptyArray['map'](fromSubscriptionKey)),option['fold'](constVoid,_0x44f402=>Promise['all'](_0x44f402['map'](_0x1576a6=>_0x2d8549['requestHistoryData'](_0x1576a6['symbol'],_0x1576a6['aggregation'],{..._0x1576a6['options'],'priceIncrement':_0x4f9f0f['get'](_0x1576a6['symbol']),'fromTime':_0x2d07cd['fromTime'],'toTime':_0x2d07cd['toTime']})['then'](_0x3480fa=>({'data':_0x3480fa,'instrument':_0x1576a6['symbol'],'type':'LAZY'}))))['then'](_0x159efe=>_0x4e198c['get'](_0x3c2d0c)?.['next'](_0x159efe)))),_0x366112=_0x552dab=>{const _0x126fe5=_0x40935a(_0x552dab)(_0x54d002);_0x4702d2(_0x552dab)(_0x126fe5)([]);},_0x59b3f0=(_0x391918,_0x1a28c2,_0x2c8c94)=>merge(..._0x2867ac(_0x391918,_0x1a28c2,_0x2c8c94)),_0x91798c={};return _0x91798c['subscribeSymbolsHistoryData']=_0x5cdcfc,_0x91798c['requestMoreHistoryData']=_0x28a3e0,_0x91798c['unsubscribeSymbolData']=_0x366112,_0x91798c['subscribeLastCandleUpdates']=_0x59b3f0,_0x91798c;});function fromSubscriptionKey(_0x477471){return pipe(_0x477471,string['split']('|'),readonlyNonEmptyArray['map'](string['split']('=')),readonlyNonEmptyArray['groupBy'](readonlyNonEmptyArray['head']),record['map'](readonlyNonEmptyArray['flatten']),record['map'](readonlyNonEmptyArray['last']),fromStringRecordToTypedData);}function fromStringRecordToTypedData(_0x5e2274){const _0x59536e=_0x5e2274['symbol'],_0x1d4740=pipe(_0x5e2274['period'],stringToAggregationPeriodSafe,option['fold'](()=>AGGREGATION_PERIOD_1_HOUR,identity)),_0x2151ad={},_0x167cb1=_0x5e2274['extendedHours'],_0x495559=parsePriceTypeFromStringSafe(_0x5e2274['priceType']),_0x499a8d=parseCandleAlignmentFromStringSafe(_0x5e2274['candleAlignment']);_0x167cb1&&(_0x2151ad['extendedHours']=_0x167cb1==='true');isSome(_0x495559)&&(_0x2151ad['priceType']=_0x495559['value']);isSome(_0x499a8d)&&(_0x2151ad['candleAlignment']=_0x499a8d['value']);const _0xa2d21d={};return _0xa2d21d['symbol']=_0x59536e,_0xa2d21d['aggregation']=_0x1d4740,_0xa2d21d['options']=_0x2151ad,_0xa2d21d;}const subscriptionId=(_0x3479b2,_0x13d26e)=>_0x3479b2+'_'+_0x13d26e;