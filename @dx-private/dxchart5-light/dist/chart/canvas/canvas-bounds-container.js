/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{BehaviorSubject as M,Subject as b}from"rxjs";import{distinctUntilChanged as C,map as T}from"rxjs/operators";import{arrayRemove2 as U,moveInArrayMutable as E,reorderArray as X}from"../utils/array.utils";import{isMobile as w}from"../utils/device/browser.utils";import{calcTimeLabelBounds as D}from"../components/navigation_map/navigation-map.model";import{calculateSymbolHeight as Y}from"../utils/canvas/canvas-font-measure-tool.utils";export const CHART_UUID="CHART";class s{}s.CANVAS="CANVAS",s.N_MAP="N_MAP",s.X_AXIS="X_AXIS",s.N_MAP_KNOT_L="N_MAP_KNOT_L",s.N_MAP_KNOT_R="N_MAP_KNOT_R",s.N_MAP_BTN_L="N_MAP_BTN_L",s.N_MAP_BTN_R="N_MAP_BTN_R",s.N_MAP_SLIDER_WINDOW="N_MAP_SLIDER_WINDOW",s.N_MAP_CHART="N_MAP_CHART",s.N_MAP_LABEL_R="N_MAP_LABEL_R",s.N_MAP_LABEL_L="N_MAP_LABEL_L",s.PANE_UUID=g=>"PANE_"+g,s.PANE_UUID_Y_AXIS=g=>"PANE_"+g+"_Y_AXIS",s.PANE_UUID_RESIZER=g=>"PANE_"+g+"_RESIZER",s.ALL_PANES="ALL_PANES",s.ALL_Y_AXIS="ALL_Y_AXIS",s.CHART_WITH_Y_AXIS="CHART_WITH_Y_AXIS",s.EVENTS="EVENTS",s.CHART=s.PANE_UUID(CHART_UUID),s.Y_AXIS=s.PANE_UUID_Y_AXIS(CHART_UUID);export{s as CanvasElement};export const DEFAULT_BOUNDS={x:0,y:0,pageX:0,pageY:0,width:0,height:0};const j=60,W=20,H=35,S=15,I=1.5,L=w()?8*I:8,F=1e-6;export class CanvasBoundsContainer{get graphsHeightRatio(){return this._graphsHeightRatio}constructor(t,e,i,h,n){this.config=t,this.eventBus=e,this.canvasModel=i,this.formatterFactory=h,this.bounds={},this.canvasOnPageLocation={x:0,y:0,pageX:0,pageY:0,width:0,height:0},this.panesOrder=[],this.panesOrderChangedSubject=new b,this.xAxisHeight=void 0,this.yAxisWidth=j,this.leftRatio=0,this.rightRatio=0,this.boundsChangedSubject=new b,this.barResizerChangedSubject=new b,this._graphsHeightRatio={chart:1},this.graphsHeightRatioChangedSubject=new b,this.boundsChangedSubscriptions={},n.canvasResized.subscribe(c=>{let a=c;a||(a=this.canvasModel.canvas.getBoundingClientRect()),this.updateCanvasOnPageLocation(a),this.recalculateBounds()})}addPaneBounds(t,e){if(this.panesOrder.indexOf(t)===-1){if(this.panesOrder.push(t),e!==void 0){const i=this.panesOrder.indexOf(t);E(this.panesOrder,i,e)}this.recalculatePanesHeightRatios()}}overrideChartHeightRatios(t){const e=Object.assign(Object.assign({},this.graphsHeightRatio),t),i=Object.values(e).reduce((h,n)=>h+n,0);Math.abs(i-1)<F?(this._graphsHeightRatio=e,this.recalculateBounds()):console.error(`Result ratio should be equal 1, but equal ${i}`)}movePaneUp(t){const e=this.panesOrder.indexOf(t);e!==-1&&(E(this.panesOrder,e,e-1),this.recalculateBounds(),this.eventBus.fireDraw(),this.panesOrderChangedSubject.next(this.panesOrder))}movePaneDown(t){const e=this.panesOrder.indexOf(t);e!==-1&&(E(this.panesOrder,e,e+1),this.recalculateBounds(),this.eventBus.fireDraw(),this.panesOrderChangedSubject.next(this.panesOrder))}reorderPanes(t){this.panesOrder=X(this.panesOrder,t),this.recalculateBounds()}removedPaneBounds(t){U(this.panesOrder,t),delete this.graphsHeightRatio[t],delete this.bounds[s.PANE_UUID(t)],delete this.bounds[s.PANE_UUID_Y_AXIS(t)],delete this.bounds[s.PANE_UUID_RESIZER(t)],this.recalculatePanesHeightRatios()}recalculateBounds(){const t=this.canvasOnPageLocation.width,e=this.canvasOnPageLocation.height,i=this.config.components.paneResizer.height,h=this.getBounds(s.CANVAS);h.x=0,h.y=0,h.width=t,h.height=e;const n=this.getYAxisWidth(),c=this.getNavMapBounds(h),a=this.getXAxisBounds(c,h),o=e-a.height-c.height,d=this.config.components.yAxis.align==="right"?h.width-n:0,_=this.config.components.yAxis.align==="right"?0:d+n,r=0,R=h.width-n;let u=r;this.panesOrder.forEach((p,f)=>{const x=this.graphsHeightRatio[this.panesOrder[f]],A=this.config.components.paneResizer.visible;A&&(f!==0?m(this.bounds,s.PANE_UUID_RESIZER(p),_,u,h.width,i,this.canvasOnPageLocation):m(this.bounds,s.PANE_UUID_RESIZER(p),0,0,0,0,this.canvasOnPageLocation));const B=m(this.bounds,s.PANE_UUID(p),_,A?u+i:u,R,A?o*x-this.config.components.paneResizer.height:o*x,this.canvasOnPageLocation);this.config.components.yAxis.visible?m(this.bounds,s.PANE_UUID_Y_AXIS(p),d,A?u+i:u,n,A?o*x-i:o*x,this.canvasOnPageLocation):m(this.bounds,s.PANE_UUID_Y_AXIS(p),0,0,0,0,this.canvasOnPageLocation),u=B.y+B.height});const N=this.getBounds(s.ALL_PANES);N.x=_,N.y=r,N.width=R,N.height=u;const O=this.getBounds(s.ALL_Y_AXIS);O.x=d,O.y=0,O.width=n,O.height=N.height;const P=this.getBounds(s.CHART_WITH_Y_AXIS),l=this.getBounds(s.PANE_UUID(CHART_UUID));this.getEventsBounds(l),this.copyBounds(l,P),P.width=h.width,this.recalculateNavigationMapElementBounds(),this.updateAllBoundsPageCoordinates(),this.notifyBoundsSubscribers()}updateCanvasOnPageLocation(t){this.canvasOnPageLocation=Object.assign(Object.assign({},this.canvasOnPageLocation),{x:t.x,y:t.y,width:t.width,height:t.height})}updateAllBoundsPageCoordinates(){for(const t of Object.keys(this.bounds)){const e=this.bounds[t];e.pageX=e.x+this.canvasOnPageLocation.x,e.pageY=e.y+this.canvasOnPageLocation.y}}getEventsBounds(t){const e=this.getBounds(s.EVENTS);return this.config.components.events.visible?(e.x=0,e.y=t.y+t.height-this.config.components.events.height,e.width=t.width,e.height=this.config.components.events.height):this.applyDefaultBounds(e),e}getNavMapBounds(t){const e=this.getBounds(s.N_MAP);return this.config.components.navigationMap.visible?(e.x=0,e.y=t.height-H,e.width=t.width,e.height=H):this.applyDefaultBounds(e),e}getXAxisBounds(t,e){const i=this.getBounds(s.X_AXIS);return this.config.components.xAxis.visible?(i.x=0,i.y=e.height-this.getXAxisHeight()-t.height,i.width=e.width,i.height=this.getXAxisHeight()):this.applyDefaultBounds(i),i}getXAxisHeight(){var t,e;if(!this.xAxisHeight){const i=this.config.components.xAxis.fontSize+"px "+this.config.components.xAxis.fontFamily,h=Y(i,this.canvasModel.ctx);this.xAxisHeight=h+((t=this.config.components.xAxis.padding.top)!==null&&t!==void 0?t:0)+((e=this.config.components.xAxis.padding.bottom)!==null&&e!==void 0?e:0)}return this.xAxisHeight}setYAxisWidth(t){t!==this.config.components.yAxis.width&&(this.config.components.yAxis.width=t,this.recalculateBounds())}setXAxisHeight(t){t!==this.xAxisHeight&&(this.xAxisHeight=t,this.recalculateBounds())}setPanesOrder(t){this.panesOrder=t,this.recalculateBounds()}getYAxisWidth(){return this.config.components.yAxis.visible?this.config.components.yAxis.width:0}recalculatePanesHeightRatios(){this.calculateGraphsHeightRatios(),this.recalculateBounds()}calculateGraphsHeightRatios(){let t=this.graphsHeightRatio[CHART_UUID];const e=[];e.push(...this.panesOrder.filter(r=>r!==CHART_UUID)),this.panesOrder.forEach(r=>{this.graphsHeightRatio[r]===0&&delete this.graphsHeightRatio[r]});const i=e.map(r=>this.graphsHeightRatio[r]===void 0?void 0:this.graphsHeightRatio[r]),h=i.filter(r=>r!==void 0).length,n=i.filter(r=>r===void 0).length;let c=0,a=0,o=1,d=0;n>0&&([o,d]=z(e.length),t*=o),h===0&&(t=1-d*n),a=1-t-d*n,i.forEach(r=>{r&&(a-=r*o)}),c=a/(e.length+1);const _=i.map(r=>r?r*o+c:d+c);t+=c,this._graphsHeightRatio={},this.graphsHeightRatio[CHART_UUID]=t,_.forEach((r,R)=>{const u=e[R];this.graphsHeightRatio[u]=r})}recalculateNavigationMapElementBounds(){var t,e,i,h;if(this.config.components.navigationMap.visible){const n=this.getBounds(s.N_MAP),{height:c,width:a}=this.config.components.navigationMap.knots,o=c!=null?c:0,d=w()?a*I:a!=null?a:0,_=o?n.y+(n.height-o)/2:n.y,r=(e=(t=this.config.components.navigationMap)===null||t===void 0?void 0:t.timeLabels)===null||e===void 0?void 0:e.visible,R=v=>D(this.canvasModel.ctx,v,this.formatterFactory,this.config)[0],u=(h=(i=this.mainCandleSeries)===null||i===void 0?void 0:i.getSeriesInViewport().flat())!==null&&h!==void 0?h:[],N=r&&u.length?R(u[0].candle.timestamp):0,O=r&&u.length?R(u[u.length-1].candle.timestamp):0,P=Math.max(N,O);if(r){const v=this.getBounds(s.N_MAP_LABEL_L);v.x=n.x,v.y=n.y,v.width=P,v.height=n.height;const y=this.getBounds(s.N_MAP_LABEL_R);y.x=n.x+n.width-P,y.y=n.y,y.width=P,y.height=n.height}const l=this.getBounds(s.N_MAP_BTN_L);l.x=n.x+P,l.y=n.y,l.width=S,l.height=n.height;const p=this.getBounds(s.N_MAP_BTN_R);p.x=n.x+n.width-S-P,p.y=n.y,p.width=S,p.height=n.height;const f=this.getBounds(s.N_MAP_KNOT_L);f.x=(p.x-l.x-l.width)*this.leftRatio+l.x+l.width,f.y=_,f.width=d!=null?d:L,f.height=o!=null?o:n.height;const x=this.getBounds(s.N_MAP_KNOT_R);x.x=(p.x-l.x-l.width)*this.rightRatio+l.x+l.width-L,x.y=_,x.width=d!=null?d:L,x.height=o!=null?o:n.height;const A=this.getBounds(s.N_MAP_SLIDER_WINDOW);A.x=f.x+f.width,A.y=n.y,A.width=x.x-A.x,A.height=n.height;const B=this.getBounds(s.N_MAP_CHART);B.x=l.x+l.width,B.y=n.y,B.width=p.x-B.x,B.height=n.height}}isVolumesInSeparatePane(){return this.config.components.volumes.visible&&this.config.components.volumes.showSeparately}getBounds(t){return this.bounds[t]===void 0&&(this.bounds[t]=this.copyOf(DEFAULT_BOUNDS)),this.bounds[t]}getCanvasOnPageLocation(){return this.canvasOnPageLocation}getBoundsPanes(){return this.panesOrder.reduce((t,e)=>Object.assign(Object.assign({},t),{[e]:this.bounds[s.PANE_UUID(e)]}),{})}getBoundsHitTest(t,e=DEFAULT_HIT_TEST_OPTIONS){const{extensionX:i,extensionY:h,wholePage:n}=Object.assign(Object.assign({},DEFAULT_HIT_TEST_OPTIONS),e);return n?(c,a)=>{const o=this.getBounds(t);return c>o.pageX-i&&c<o.pageX+o.width+i&&a>o.pageY-h&&a<o.pageY+o.height+h}:(c,a)=>{const o=this.getBounds(t);return c>o.x-i&&c<o.x+o.width+i&&a>o.y-h&&a<o.y+o.height+h}}static hitTestOf(t,e=DEFAULT_HIT_TEST_OPTIONS){const{extensionX:i,extensionY:h,wholePage:n}=Object.assign(Object.assign({},DEFAULT_HIT_TEST_OPTIONS),e);return n?(c,a)=>c>t.pageX-i&&c<t.pageX+t.width+i&&a>t.pageY-h&&a<t.pageY+t.height+h:(c,a)=>c>t.x-i&&c<t.x+t.width+i&&a>t.y-h&&a<t.y+t.height+h}isChartBoundsAvailable(){const t=this.getBounds(s.CANVAS);return t.width>0&&t.height>0}resizePaneVertically(t,e){const i=this.panesOrder.indexOf(t),h=this.getBounds(s.PANE_UUID_RESIZER(t));this.doResizePaneVertically(i,h.y-e),this.barResizerChangedSubject.next()}doResizePaneVertically(t,e){const i=t-1,h=this.getBounds(s.ALL_PANES).height,n=this.config.components.paneResizer.height+W,c=h*this.graphsHeightRatio[this.panesOrder[t]],a=h*this.graphsHeightRatio[this.panesOrder[i]],o=c+e>n,d=a-e>n;if(o&&d){const _=e/h;this.graphsHeightRatio[this.panesOrder[t]]+=_,this.graphsHeightRatio[this.panesOrder[i]]-=_,this.recalculateBounds()}}notifyBoundsSubscribers(){Object.keys(this.boundsChangedSubscriptions).forEach(t=>{this.boundsChangedSubscriptions[t].next(this.getBounds(t))}),this.boundsChangedSubject.next()}observeBoundsChanged(t){let e=this.boundsChangedSubscriptions[t];return e||(e=new M(this.getBounds(t)),this.boundsChangedSubscriptions[t]=e),e.pipe(T(i=>this.copyOf(i)),C((i,h)=>this.sameBounds(i,h)))}observeAnyBoundsChanged(){return this.boundsChangedSubject.asObservable()}copyOf(t){return Object.assign({},t)}copyBounds(t,e){e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height}sameBounds(t,e){return t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height}applyDefaultBounds(t){this.copyBounds(DEFAULT_BOUNDS,t)}setMainCandleSeries(t){this.mainCandleSeries=t}}const V={0:1,1:.8,2:.6,3:.5,4:.4,5:.2},z=g=>{var t;const e=(t=V[g])!==null&&t!==void 0?t:.4,i=(1-e)/g;return[e,i]};export const isInBounds=(g,t)=>g.x>t.x&&g.x<t.x+t.width&&g.y>t.y&&g.y<t.y+t.height,isInVerticalBounds=(g,t)=>g>t.y&&g<t.y+t.height;const m=(g,t,e,i,h,n,c)=>{const a=g[t];if(a)return a.x=e,a.y=i,a.pageX=e+c.x,a.pageY=i+c.y,a.width=h,a.height=n,a;const o={x:e,y:i,pageX:e+c.x,pageY:i+c.y,width:h,height:n};return g[t]=o,o};export const limitYToBounds=(g,t)=>Math.min(Math.max(g,t.y),t.y+t.height),DEFAULT_HIT_TEST_OPTIONS={extensionX:0,extensionY:0,wholePage:!1},areBoundsChanged=(g,t)=>g.width===t.width&&g.height===t.height;
