/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{distinctUntilChanged as w}from"rxjs/operators";import{areBoundsChanged as P,CanvasElement as o}from"../../canvas/canvas-bounds-container";import{ChartBaseElement as C}from"../../model/chart-base-element";import{DataSeriesModel as S,VisualSeriesPoint as D,defaultValueFormatter as A}from"../../model/data-series.model";import{mergeHighLow as x}from"../../model/scaling/auto-scale.model";import{createPaneFormatters as V}from"../chart/price.formatter";import{firstOf as M,lastOf as U}from"../../utils/array.utils";export class PaneComponent extends C{constructor(e,t,s,d,h,u,l,c,m,v,p,f=[],g=new Set,B={regular:A}){super(),this.chartBaseModel=e,this.config=t,this.eventBus=s,this.canvasBoundsContainer=d,this.uuid=h,this.scaleModel=u,this.yAxisLabelsGenerator=l,this.yAxisDrawer=c,this.yAxisScaleHandler=m,this.hitTestController=v,this.dataSeriesCanvasModel=p,this.subs=f,this.dataSeries=g,this.formatters=B,this._paneOrder=0,this.getYAxisBounds=()=>this.canvasBoundsContainer.getBounds(o.PANE_UUID_Y_AXIS(this.uuid)),this.toVisualPoints=a=>a.map(i=>new D(this.chartBaseModel.dataFromTimestamp(i.timestamp).centerUnit,i.close)),this.valueFormatter=(a,i)=>{var r;return((r=this.formatters[this.getAxisType()])!==null&&r!==void 0?r:this.formatters.regular)(a,i)},this.ht=this.canvasBoundsContainer.getBoundsHitTest(o.PANE_UUID(h),{extensionY:-this.config.components.paneResizer.dragZone}),this.setPaneValueFormatters(V(this))}doActivate(){super.doActivate(),this.addRxSubscription(this.canvasBoundsContainer.observeBoundsChanged(o.PANE_UUID(this.uuid)).pipe(w(P)).subscribe(()=>this.scaleModel.recalculateZoomY()))}setDataPoints(e,t){this.dataSeries.has(e)&&(e.dataPoints=t,this.updateView())}updateView(){this.scaleModel.doAutoScale(),this.eventBus.fireDraw()}getBounds(){return this.scaleModel.getBounds()}hide(){this._paneOrder=this.canvasBoundsContainer.panesOrder.indexOf(this.uuid),this.canvasBoundsContainer.removedPaneBounds(this.uuid),this.eventBus.fireDraw()}show(){this.canvasBoundsContainer.addPaneBounds(this.uuid,this._paneOrder),this.eventBus.fireDraw()}createDataSeries(){const e=new S(this,this.hitTestController.getNewDataSeriesHitTestId());return e.toVisualPoints=this.toVisualPoints,e}addDataSeries(e){this.dataSeries.add(e),this.dataSeries.size===1&&(this.mainDataSeries=e),this.updateView()}removeDataSeries(e){this.dataSeries.delete(e),this.updateView()}getAxisType(){return"regular"}moveUp(){this.canvasBoundsContainer.movePaneUp(this.uuid)}moveDown(){this.canvasBoundsContainer.movePaneDown(this.uuid)}canMoveUp(){const e=M(this.canvasBoundsContainer.panesOrder);return this.uuid!==e}canMoveDown(){const e=U(this.canvasBoundsContainer.panesOrder);return this.uuid!==e}get regularFormatter(){return this.formatters.regular}setPaneValueFormatters(e){this.formatters=e}regularValueFromY(e){var t,s;return(s=(t=this.mainDataSeries)===null||t===void 0?void 0:t.view.priceFromY(e))!==null&&s!==void 0?s:this.scaleModel.fromY(e)}}export const createDefaultPaneHighLowProvider=n=>({isHighLowActive:()=>!0,calculateHighLow:e=>{const t=Array.from(n.dataSeries).filter(s=>s.highLowProvider.isHighLowActive()).map(s=>s.highLowProvider.calculateHighLow(e));return x(t)}});
