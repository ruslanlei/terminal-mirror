/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{merge as C}from"rxjs";import{filter as _,pairwise as N}from"rxjs/operators";import{ChartBaseElement as f}from"../../model/chart-base-element";import{CanvasElement as e}from"../../canvas/canvas-bounds-container";import{EVENT_RESIZED as g}from"../../events/events";import{NavigationMapDrawer as I}from"./navigation-map.drawer";import{NavigationMapMoveHandler as E}from"./navigation-map-move.handler";import{floor as A}from"../../utils/math.utils";export class NavigationMapComponent extends f{constructor(s,t,c,a,i,m,o,d,h,n){super(),this.eventBus=s,this.chartModel=t,this.canvasModel=c,this.config=a,this.canvasInputListeners=i,this.canvasBoundsContainer=m,this.chartPanComponent=h,this.visualCandles=[];const l=new I(a,t,c,m,d,()=>this.visualCandles);o.addDrawer(l,e.N_MAP_CHART),this.navigationMapMoveHandler=new E(this.eventBus,this.chartModel,this.chartModel.scaleModel,this.canvasInputListeners,this.canvasBoundsContainer,this.chartPanComponent),n.addCursorForCanvasEl(e.N_MAP_CHART,a.components.navigationMap.cursors.chart),n.addCursorForCanvasEl(e.N_MAP_BTN_L,a.components.navigationMap.cursors.buttonLeft),n.addCursorForCanvasEl(e.N_MAP_BTN_R,a.components.navigationMap.cursors.buttonRight),n.addCursorForCanvasEl(e.N_MAP_KNOT_L,a.components.navigationMap.cursors.leftResizer),n.addCursorForCanvasEl(e.N_MAP_KNOT_R,a.components.navigationMap.cursors.rightResizer),n.addCursorForCanvasEl(e.N_MAP_SLIDER_WINDOW,a.components.navigationMap.cursors.slider)}doActivate(){super.doActivate(),this.addRxSubscription(C(this.chartModel.observeCandlesChanged(),this.canvasBoundsContainer.observeBoundsChanged(e.N_MAP),this.chartModel.scaleModel.xChanged.pipe(N(),_(([s,t])=>{const a=s.start<0||s.end>0,i=t.start<0||t.end>0;return a&&!i||i}))).subscribe(()=>{this.config.components.navigationMap.visible&&(this.visualCandles=this.makeVisualCandles(),this.canvasModel.fireDraw())}))}makeVisualCandles(){var s;const t=this.chartModel.getCandles();if(!t.length)return[];const c=this.chartModel.mainCandleSeries.dataIdxStart,a=this.chartModel.mainCandleSeries.dataIdxEnd,i=Math.round(Math.max(-c,0)),m=Math.max(this.chartModel.getCandlesCountWithRightOffset(),a)+i;let o=Number.NEGATIVE_INFINITY,d=Number.POSITIVE_INFINITY;const h=this.canvasBoundsContainer.getBounds(e.N_MAP_CHART),n=h.width,l=[];let v=0,r,p;for(r=0;r<n;r++)p=A(r*m/n)-i,p in t?(l[r]=t[p].close,v=(s=l[r])!==null&&s!==void 0?s:0,o=Math.max(o,v),d=Math.min(d,v)):l[r]=0;return o-=d,l.map((u,M)=>[M+h.x,(o+d-u)*h.height/o+h.y])}setVisible(s=!0){var t;!((t=this.config.components)===null||t===void 0)&&t.navigationMap&&(this.config.components.navigationMap.visible=s,this.eventBus.fire(g),this.canvasModel.fireDraw())}}
