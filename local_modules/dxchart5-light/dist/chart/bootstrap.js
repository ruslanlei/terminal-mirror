/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{merge as G}from"rxjs";import{CanvasAnimation as Y}from"./animation/canvas-animation";import{CHART_UUID as N,CanvasBoundsContainer as W,CanvasElement as S}from"./canvas/canvas-bounds-container";import{CursorHandler as Z}from"./canvas/cursor.handler";import{createDefaultLayoutTemplate as X,extractElements as j}from"./canvas/layout-creator";import{ChartEvents as q}from"./chart-events";import{mergeWithDefaultConfig as J}from"./chart.config";import{ChartComponent as K}from"./components/chart/chart.component";import{ChartModel as Q}from"./components/chart/chart.model";import{CrossToolComponent as $}from"./components/cross_tool/cross-tool.component";import{EventsComponent as tt}from"./components/events/events.component";import{GridComponent as et}from"./components/grid/grid.component";import{HighLowComponent as st}from"./components/high_low/high-low.component";import{HighlightsComponent as nt}from"./components/highlights/highlights.component";import{NavigationMapComponent as ot}from"./components/navigation_map/navigation-map.component";import{ChartPanComponent as it}from"./components/pan/chart-pan.component";import{PaneManager as rt}from"./components/pane/pane-manager.component";import{SnapshotComponent as at}from"./components/snapshot/snapshot.component";import{VolumesComponent as ht}from"./components/volumes/volumes.component";import{WaterMarkComponent as ct}from"./components/watermark/water-mark.component";import{XAxisComponent as mt}from"./components/x_axis/x-axis.component";import{YAxisComponent as pt}from"./components/y_axis/y-axis.component";import{createCanvasModel as f,createMainCanvasModel as dt}from"./drawers/canvas.model";import{ClearCanvasDrawer as L}from"./drawers/clear-canvas.drawer";import{DrawingManager as lt}from"./drawers/drawing-manager";import Ct from"./event-bus";import{EVENT_DRAW as ut}from"./events";import{CandleTapHandler as vt}from"./inputhandlers/candle-tap.handler";import{ChartResizeHandler as gt}from"./inputhandlers/chart-resize.handler";import{CrossEventProducerComponent as ft}from"./inputhandlers/cross-event-producer.component";import{HoverProducerComponent as Mt}from"./inputhandlers/hover-producer.component";import{CanvasInputListenerComponent as wt}from"./inputlisteners/canvas-input-listener.component";import{HitTestCanvasModel as bt}from"./model/hit-test-canvas.model";import{ScaleModel as Tt}from"./model/scale.model";import{TimeZoneModel as Et}from"./model/time-zone.model";import{clearerSafe as Ht}from"./utils";import{merge as At}from"./utils/merge.utils";export default class x{constructor(t,n={}){var s,h;this.components=[],this.chartComponents=[],this.userInputListenerComponents=[],this.canvasModels=[],this.parentElement=t,this.events=new q(this);const e=n;J(e),this.config=e;const M=X();t.innerHTML="",t.appendChild(M.content),this.id=(s=t.getAttribute("data-id"))!==null&&s!==void 0?s:"",e.fixedSize&&(t.style.width=e.fixedSize.width+"px",t.style.height=e.fixedSize.height+"px");const C=new Et(e);this.timeZoneModel=C;const w=this.timeZoneModel.getFormatterFactory(),r=j(t);this.elements=r;const o=new Ct(e);this.bus=o;const u=new gt(t,(h=r.chartResizer)!==null&&h!==void 0?h:t,o,this.canvasModels,e);this.chartResizeHandler=u,u.subscribeResize(),this.components.push(u.unsubscribeAnimationUpdate.bind(u));const i=new lt(o,u);this.drawingManager=i;const d=dt(o,r.mainCanvas,r.chartResizer,this.config.components.chart.type,this.config,i,this.canvasModels);this.mainCanvasModel=d;const T=f(o,r.overDataSeriesCanvas,e,i,this.canvasModels,r.chartResizer);this.overSeriesCanvasModel=T;const y=new L(T);i.addDrawer(y,"OVER_SERIES_CLEAR"),this.dataSeriesCanvasModel=f(o,r.dataSeriesCanvas,e,i,this.canvasModels,r.chartResizer);const I=new L(this.dataSeriesCanvasModel);i.addDrawer(I,"SERIES_CLEAR");const D=f(o,r.yAxisLabelsCanvas,e,i,this.canvasModels,r.chartResizer),a=new W(e,o,d,w,u);this.canvasBoundsContainer=a;const b=r.mainCanvas.parentElement;if(b===null)throw new Error("Couldn't get main canvas parent");const c=new wt(o,b);this.canvasInputListener=c,this.chartComponents.push(this.canvasInputListener);const g=new bt(o,r.hitTestCanvas,c,a,i,e,this.canvasModels,r.chartResizer);this.hitTestCanvasModel=g;const F=new L(g);i.addDrawer(F,"HIT_TEST_CLEAR");const E=new Y(o);this.canvasAnimation=E;const p=new Tt(e,()=>a.getBounds(S.CHART),E);this.scaleModel=p;const H=f(o,r.backgroundCanvas,e,i,this.canvasModels,r.chartResizer);this.backgroundCanvasModel=H,this.cursorHandler=new Z(r.canvasArea,c,a,e,g),this.chartComponents.push(this.cursorHandler),this.crossEventProducer=new ft(o,c,a),this.chartComponents.push(this.crossEventProducer);const v=new it(o,p,a,e,E,c,b);this.chartPanComponent=v,this.chartComponents.push(v),this.userInputListenerComponents.push(v.chartAreaPanHandler);const l=new rt(this.userInputListenerComponents,o,p,a,e,E,c,i,this.dataSeriesCanvasModel,this.cursorHandler,this.crossEventProducer,v,d);this.paneManager=l,this.chartComponents.push(l),this.chartModel=new Q(l,o,this.dataSeriesCanvasModel,e,p,w,b,a,u);const A=new K(this.chartModel,this.dataSeriesCanvasModel,e,p,a,i,g,c,H,v,l,this.cursorHandler);this.chartComponents.push(A),this.chartComponent=A;const m=this.chartComponent.chartModel;this.chartModel=m,this.canvasBoundsContainer.setMainCandleSeries(this.chartModel.mainCandleSeries),g.addSubscriber(l.hitTestController),this.xAxisComponent=new mt(o,e,d,A,p,a,c,u,this.drawingManager,C,v,this.cursorHandler,H),this.chartComponents.push(this.xAxisComponent),this.userInputListenerComponents.push(this.xAxisComponent);const P=new L(d);i.addDrawer(P,"MAIN_CLEAR");const z=new vt(b,m,c,e);this.chartComponents.push(z),this.watermarkComponent=new ct(l,m,o,e,a,T,i),this.chartComponents.push(this.watermarkComponent);const _=f(o,r.crossToolCanvas,e,i,this.canvasModels,r.chartResizer);this.highlightsComponent=new nt(o,e,m,d,a,i),this.chartComponents.push(this.highlightsComponent),e.useUTCTimeOverride&&e.dateFormatter&&!e.dateFormatter.utcTimeOverride&&(e.dateFormatter.utcTimeOverride=this.createUTCTimeOverrideConfig(m)),this.navigationMapComponent=new ot(o,m,d,e,c,a,i,w,v,this.cursorHandler),this.chartComponents.push(this.navigationMapComponent),this.userInputListenerComponents.push(this.navigationMapComponent.navigationMapMoveHandler);const U=new st(e,this.dataSeriesCanvasModel,m,a,i);this.chartComponents.push(U),this.yAxisComponent=new pt(o,e,d,D,m,p,this.canvasInputListener,a,this.drawingManager,v,l,this.cursorHandler),this.chartComponents.push(this.yAxisComponent),this.userInputListenerComponents.push(this.yAxisComponent.yAxisScaleHandler),this.volumesComponent=new ht(this.dataSeriesCanvasModel,A,p,a,i,e,l),this.chartComponents.push(this.volumesComponent);const V=new et(d,p,e,"GRID",i,()=>this.canvasBoundsContainer.getBounds(S.ALL_PANES),()=>this.canvasBoundsContainer.getBounds(S.PANE_UUID(N)),()=>this.xAxisComponent.xAxisLabelsGenerator.labels,()=>this.yAxisComponent.yAxisModel.yAxisBaseLabelsModel.labels,()=>this.chartModel.toY(this.chartModel.getBaseLine()),()=>e.components.grid.visible);this.chartComponents.push(V),this.crossToolComponent=new $(o,e,m,_,a,c,i,w,C,l),this.chartComponents.push(this.crossToolComponent),this.hoverProducer=new Mt(this.crossEventProducer,o,p,e,m,c,()=>this.crossToolComponent.model.xFormatter,this.canvasBoundsContainer,this.paneManager),this.chartComponents.push(this.hoverProducer);const O=f(o,r.snapshotCanvas,e,i,this.canvasModels,r.chartResizer),B=new at(this.elements,O);this.snapshotComponent=B,this.chartComponents.push(B);const R=new tt(e,T,g,m,a,i,w,this.cursorHandler,H);this.eventsComponent=R,this.chartComponents.push(R),this.chartComponents.forEach(k=>k.activate()),this.enableUserControls(),i.reorderDrawers(e.drawingOrder),this.clearer=Ht(this.components)}createUTCTimeOverrideConfig(t){const n=new RegExp("HH|H|mm|m|s|ss|sss|SSS");return{pattern:"MM/dd/YY",test:s=>n.test(s)&&(t.getPeriod()||0)>=86400}}static mergeConfig(t,n){for(const s in n)s in t?typeof t[s]=="object"&&x.mergeConfig(t[s],n[s]):t[s]=n[s];return t}getConfig(){return this.config}setRtl(t){this.config.rtl=t,this.bus.fire(ut)}setChartType(t){this.chartComponent.setChartType(t)}disableUserControls(){this.userInputListenerComponents.forEach(t=>t.deactivate()),this.hitTestCanvasModel.disableUserControls()}enableUserControls(){this.userInputListenerComponents.forEach(t=>t.activate()),this.hitTestCanvasModel.enableUserControls()}setGridConfig(t){var n,s,h,e,M;const C=this.config.components.grid;C.visible=(n=t.visible)!==null&&n!==void 0?n:!1,C.dash=(s=t.dash)!==null&&s!==void 0?s:[0,0],C.width=(h=t.width)!==null&&h!==void 0?h:1,C.color=(e=t.color)!==null&&e!==void 0?e:"#FFFFFF",this.config.colors.chartAreaTheme.gridColor=(M=t.color)!==null&&M!==void 0?M:"#FFFFFF",this.redraw()}setGridVisible(t){this.config.components&&this.config.components.grid&&(this.config.components.grid.visible=t,this.redraw())}setGridVertical(t){this.config.components.grid.vertical=t,this.redraw()}setGridHorizontal(t){this.config.components.grid.horizontal=t,this.redraw()}deactivate(){this.clearer(),this.disableUserControls(),this.chartComponents.forEach(t=>t.deactivate())}redraw(){this.bus.fireDraw()}getOffsets(){return this.config.components&&this.config.components.offsets}showSeparateVolumes(t=!1){this.volumesComponent&&(this.volumesComponent.setShowVolumesSeparatly(t),this.cursorHandler.toggleVolumesMode(t),this.yAxisComponent.yAxisModel.updateYAxisWidth())}setAutoScale(t=!0){this.scaleModel.autoScale(t)}setShowCandleBorders(t=!0){this.config.components&&this.config.components.chart&&(this.config.components.chart.showCandlesBorder=t,this.redraw())}valueToY(t){return this.chartModel.toY(t)}setHighLowVisible(t=!0){this.config.components&&this.config.components.highLow&&(this.config.components.highLow.visible=t,this.redraw())}setCrossToolVisible(t="cross-and-labels"){this.config.components&&this.config.components.crossTool&&(this.config.components.crossTool.type=t,this.redraw())}setHighlightsVisible(t=!0){var n;!((n=this.config.components)===null||n===void 0)&&n.highlights&&(this.config.components.highlights.visible=t,this.redraw())}setHighlightsData(t){this.highlightsComponent.setHighlights(t)}setColors(t){At(this.config.colors,t,{addIfMissing:!0,overrideExisting:!0}),this.redraw()}addMouseMoveOnChartElementHandler(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=this.canvasInputListener.observeMouseMove(s).subscribe(n);return()=>h.unsubscribe()}addMouseEnterOnChartElementHandler(t,n,s=!1){const h=this.canvasBoundsContainer.getBoundsHitTest(t),e=this.canvasInputListener.observeMouseEnter(h,s).subscribe(n);return()=>e.unsubscribe()}addClickOnChartElementHandler(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=this.canvasInputListener.observeClick(s).subscribe(n);return()=>h.unsubscribe()}addDragEventsListener(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=G(this.canvasInputListener.observeYDrag(s),this.canvasInputListener.observeXDrag(s)).subscribe(n);return()=>h.unsubscribe()}destroy(){this.bus.setMuted(!0),this.chartComponents.forEach(t=>t.disable()),this.parentElement.childNodes.forEach(t=>t.remove()),this.parentElement.style.width="",this.parentElement.style.height=""}registerComponent(t,n){const s=t(this);this.components.push(s),n&&n(s),s.activate()}registerPaneFormatters(t,n){var s;(s=this.paneManager.paneComponents[t])===null||s===void 0||s.setPaneValueFormatters(n)}}
