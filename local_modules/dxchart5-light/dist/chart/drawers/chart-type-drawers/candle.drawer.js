/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{CandleSeriesModel as v}from"../../model/candle-series.model";import{avoidAntialiasing as S}from"../../utils/canvas-drawing-functions.utils";import{dpr as L,floorToDPR as m}from"../../utils/device-pixel-ratio.utils";import{setLineWidth as $}from"../data-series.drawer";export class CandleDrawer{constructor(i){this.config=i,this.pixelLength=1,this.lineWidthCU=1,this.halfLineWidthCU=1}draw(i,e,s,o){if(s instanceof v){const r=e.flat();$(i,this.config.candleLineWidth,s,o,this.config.candleLineWidth),S(i,()=>{this.pixelLength=1/L,this.halfLineWidthCU=i.lineWidth/2,this.lineWidthCU=i.lineWidth;for(const f of r){const{candleTheme:l,activeCandleTheme:n}=s.colors;l&&n&&this.drawCandle(i,o,s,f)}})}}drawCandle(i,e,s,o){const{candleTheme:r,activeCandleTheme:f}=s.colors,l=o.name,n=o.isActive?f:r,d=o.isHollow;e.singleColor?i.fillStyle=e.singleColor:d?i.fillStyle=n[`${l}WickColor`]:i.fillStyle=n[`${l}Color`];const t=m(s.view.toX(o.startUnit)),a=m(s.view.xPixels(o.width)),w=o.bodyHeight(s.view),[c,h,W,g]=o.yBodyKeyPoints(s.view),T=n[`${l}Color`],P=l==="none"?T:n[`${l}WickColor`];i.fillStyle=T,e.singleColor?i.strokeStyle=e.singleColor:i.strokeStyle=P;const b=d||(o.hasBorder&&o.isActive?this.config.showActiveCandlesBorder:this.config.showCandlesBorder),k=this.config.showWicks;if(a<2)i.beginPath(),i.moveTo(t,k?c:h),i.lineTo(t,k?g:W),i.stroke();else if(a<3)i.beginPath(),i.moveTo(t,k?c:h),i.lineTo(t,k?g:W),i.moveTo(t+1,h),i.lineTo(t+1,W),i.stroke();else if(a===3){const C=a/L;this.drawCandlesWicks(i,t+C,c,g,h,W),d||(i.beginPath(),i.moveTo(t+C,h),i.lineTo(t+C,W),i.stroke()),this.drawCandleBorder(i,e,n,o,t+this.halfLineWidthCU,h+this.halfLineWidthCU,a-this.lineWidthCU,w-this.lineWidthCU)}else{const C=m(s.view.toX(o.centerUnit));this.drawCandlesWicks(i,C,c,g,h,W-1);const B=this.config.candlePaddingPercent,y=Math.max(m(a*B/2),this.pixelLength),U=t+y,p=a-y*2;d||(e.singleColor&&(i.fillStyle=e.singleColor),i.fillRect(U,h,p,w)),b&&this.drawCandleBorder(i,e,n,o,U+this.halfLineWidthCU,h+this.halfLineWidthCU,p-this.lineWidthCU,w-this.lineWidthCU)}}drawCandlesWicks(i,e,s,o,r,f){this.config.showWicks&&(i.beginPath(),i.moveTo(e,s),i.lineTo(e,r),i.moveTo(e,f),i.lineTo(e,o),i.stroke())}drawCandleBorder(i,e,s,o,r,f,l,n){if(e.singleColor)i.strokeStyle=e.singleColor;else{const d=o.name;i.strokeStyle=d==="none"?s[`${d}Color`]:s[`${d}WickColor`]}i.strokeRect(r,f,l,n)}}
