/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{CandleSeriesModel as $}from"../../model/candle-series.model";import{avoidAntialiasing as X}from"../../utils/canvas-drawing-functions.utils";import{dpr as P,floorToDPR as m}from"../../utils/device-pixel-ratio.utils";import{setLineWidth as A}from"../data-series.drawer";export class CandleDrawer{constructor(i){this.config=i,this.pixelLength=1,this.lineWidthCU=1,this.halfLineWidthCU=1}draw(i,e,s,o){if(s instanceof $){const r=e.flat();A(i,this.config.candleLineWidth,s,o,this.config.candleLineWidth),X(i,()=>{this.pixelLength=1/P,this.halfLineWidthCU=i.lineWidth/2,this.lineWidthCU=i.lineWidth;for(const f of r){const{candleTheme:h,activeCandleTheme:l}=s.colors;h&&l&&this.drawCandle(i,o,s,f)}})}}drawCandle(i,e,s,o){const{candleTheme:r,activeCandleTheme:f}=s.colors,h=o.name,l=o.isActive?f:r,d=o.isHollow;e.singleColor?i.fillStyle=e.singleColor:d?i.fillStyle=l[`${h}WickColor`]:i.fillStyle=l[`${h}Color`];const t=m(s.view.toX(o.startUnit)),a=m(s.view.xPixels(o.width)),w=o.bodyHeight(s.view),[W,n,y,T]=o.yBodyKeyPoints(s.view),c=n===y?n+1:y,g=W===T?W+1:T,U=l[`${h}Color`],B=h==="none"?U:l[`${h}WickColor`];i.fillStyle=U,e.singleColor?i.strokeStyle=e.singleColor:i.strokeStyle=B;const v=d||(o.hasBorder&&o.isActive?this.config.showActiveCandlesBorder:this.config.showCandlesBorder),k=this.config.showWicks;if(a<2)i.beginPath(),i.moveTo(t,k?W:n),i.lineTo(t,k?g:c),i.stroke();else if(a<3)i.beginPath(),i.moveTo(t,k?W:n),i.lineTo(t,k?g:c),i.moveTo(t+1,n),i.lineTo(t+1,c),i.stroke();else if(a===3){const C=a/P;this.drawCandlesWicks(i,t+C,W,g,n,c),d||(i.beginPath(),i.moveTo(t+C,n),i.lineTo(t+C,c),i.stroke()),this.drawCandleBorder(i,e,l,o,t+this.halfLineWidthCU,n+this.halfLineWidthCU,a-this.lineWidthCU,w-this.lineWidthCU)}else{const C=m(s.view.toX(o.centerUnit));this.drawCandlesWicks(i,C,W,g,n,c-1);const S=this.config.candlePaddingPercent,p=Math.max(m(a*S/2),this.pixelLength),L=t+p,b=a-p*2;d||(e.singleColor&&(i.fillStyle=e.singleColor),i.fillRect(L,n,b,w)),v&&this.drawCandleBorder(i,e,l,o,L+this.halfLineWidthCU,n+this.halfLineWidthCU,b-this.lineWidthCU,w-this.lineWidthCU)}}drawCandlesWicks(i,e,s,o,r,f){this.config.showWicks&&(i.beginPath(),i.moveTo(e,s),i.lineTo(e,r),i.moveTo(e,f),i.lineTo(e,o),i.stroke())}drawCandleBorder(i,e,s,o,r,f,h,l){if(e.singleColor)i.strokeStyle=e.singleColor;else{const d=o.name;i.strokeStyle=d==="none"?s[`${d}Color`]:s[`${d}WickColor`]}i.strokeRect(r,f,h,l)}}
