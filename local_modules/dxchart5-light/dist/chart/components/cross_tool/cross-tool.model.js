/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{merge as c}from"rxjs";import{ChartBaseElement as n}from"../../model/chart-base-element";import{EVENT_CLOSE_HOVER as l,EVENT_HOVER as h}from"../../events/events";import{recalculateXFormatter as u}from"../../model/date-time.formatter";export class CrossToolModel extends n{constructor(e,t,r,s,i,o,a){super(),this.eventBus=e,this.config=t,this.crossToolCanvasModel=r,this.canvasInputListener=s,this.chartModel=i,this.timeZoneModel=o,this.formatterFactory=a,this.currentHover=null,this.type="cross-and-labels",this.xFormatter=()=>"",this.type=t.type}setType(e){this.type=e}doActivate(){super.doActivate(),this.addRxSubscription(this.canvasInputListener.observeMouseMove().subscribe(()=>{this.fireDraw()})),this.addSubscription(this.eventBus.on(h,(e,t)=>{t&&(this.updateHover(e),this.fireDraw())})),this.addSubscription(this.eventBus.on(l,()=>{this.currentHover=null,this.fireDraw()})),this.addRxSubscription(c(this.chartModel.candlesSetSubject,this.timeZoneModel.observeTimeZoneChanged()).subscribe(()=>this.recalculateCrossToolXFormatter()))}fireDraw(){this.type!=="none"&&this.crossToolCanvasModel.fireDraw()}updateHover(e){if(this.currentHover===null?this.currentHover={x:e.x,y:0,time:e.timeFormatted}:(this.currentHover.x=e.x,this.currentHover.time=e.timeFormatted),e.candleHover)switch(this.config.magnetTarget){case"O":this.currentHover.y=e.candleHover.openY;break;case"C":this.currentHover.y=e.candleHover.closeY;break;case"H":this.currentHover.y=e.candleHover.highY;break;case"L":this.currentHover.y=e.candleHover.lowY;break;case"OHLC":this.currentHover.y=e.candleHover.closestOHLCY;break;case"none":this.currentHover.y=e.y;break}else this.currentHover.y=e.y}recalculateCrossToolXFormatter(){const e=this.config.xAxisLabelFormat;this.xFormatter=u(e,this.chartModel.getPeriod(),this.formatterFactory)}}
