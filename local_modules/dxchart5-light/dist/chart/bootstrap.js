/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{merge as Y}from"rxjs";import{mergeWithDefaultConfig as N}from"./chart.config";import{ChartEvents as W}from"./chart-events";import Z from"./event-bus";import{CanvasAnimation as X}from"./animation/canvas-animation";import{CHART_UUID as j,CanvasBoundsContainer as q,CanvasElement as x}from"./canvas/canvas-bounds-container";import{CursorHandler as J}from"./canvas/cursor.handler";import{createDefaultLayoutTemplate as K,extractElements as Q}from"./canvas/layout-creator";import{ChartComponent as $}from"./components/chart/chart.component";import{ChartModel as tt}from"./components/chart/chart.model";import{CrossToolComponent as et}from"./components/cross_tool/cross-tool.component";import{EventsComponent as st}from"./components/events/events.component";import{GridComponent as nt}from"./components/grid/grid.component";import{HighLowComponent as ot}from"./components/high_low/high-low.component";import{HighlightsComponent as it}from"./components/highlights/highlights.component";import{NavigationMapComponent as rt}from"./components/navigation_map/navigation-map.component";import{ChartPanComponent as at}from"./components/pan/chart-pan.component";import{PaneManager as ht}from"./components/pane/pane-manager.component";import{SnapshotComponent as ct}from"./components/snapshot/snapshot.component";import{VolumesComponent as mt}from"./components/volumes/volumes.component";import{WaterMarkComponent as pt}from"./components/watermark/water-mark.component";import{XAxisComponent as dt}from"./components/x_axis/x-axis.component";import{YAxisComponent as lt}from"./components/y_axis/y-axis.component";import{createCanvasModel as f,createMainCanvasModel as Ct}from"./drawers/canvas.model";import{ClearCanvasDrawer as L}from"./drawers/clear-canvas.drawer";import{DrawerType as T,DrawingManager as ut}from"./drawers/drawing-manager";import{EVENT_DRAW as vt}from"./events";import{CandleTapHandler as gt}from"./inputhandlers/candle-tap.handler";import{ChartResizeHandler as ft}from"./inputhandlers/chart-resize.handler";import{CrossEventProducerComponent as Mt}from"./inputhandlers/cross-event-producer.component";import{HoverProducerComponent as wt}from"./inputhandlers/hover-producer.component";import{CanvasInputListenerComponent as bt}from"./inputlisteners/canvas-input-listener.component";import{HitTestCanvasModel as Tt}from"./model/hit-test-canvas.model";import{ScaleModel as Et}from"./model/scale.model";import{TimeZoneModel as Ht}from"./model/time-zone.model";import{clearerSafe as At}from"./utils";import{merge as Lt}from"./utils/merge.utils";export default class B{constructor(t,n={}){var s,h;this.components=[],this.chartComponents=[],this.userInputListenerComponents=[],this.canvasModels=[],this.parentElement=t,this.events=new W(this);const e=n;N(e),this.config=e;const M=K();t.innerHTML="",t.appendChild(M.content),this.id=(s=t.getAttribute("data-id"))!==null&&s!==void 0?s:"",e.fixedSize&&(t.style.width=e.fixedSize.width+"px",t.style.height=e.fixedSize.height+"px");const C=new Ht(e);this.timeZoneModel=C;const w=this.timeZoneModel.getFormatterFactory(),r=Q(t);this.elements=r;const o=new Z(e);this.bus=o;const u=new ft(t,(h=r.chartResizer)!==null&&h!==void 0?h:t,o,this.canvasModels,e);this.chartResizeHandler=u,u.subscribeResize(),this.components.push(u.unsubscribeAnimationUpdate.bind(u));const i=new ut(o,u);this.drawingManager=i;const d=Ct(o,r.mainCanvas,r.chartResizer,this.config.components.chart.type,this.config,i,this.canvasModels);this.mainCanvasModel=d;const E=f(o,r.overDataSeriesCanvas,e,i,this.canvasModels,r.chartResizer);this.overSeriesCanvasModel=E;const I=new L(E);i.addDrawer(I,T.OVER_SERIES_CLEAR),this.dataSeriesCanvasModel=f(o,r.dataSeriesCanvas,e,i,this.canvasModels,r.chartResizer);const D=new L(this.dataSeriesCanvasModel);i.addDrawer(D,T.SERIES_CLEAR);const F=f(o,r.yAxisLabelsCanvas,e,i,this.canvasModels,r.chartResizer),a=new q(e,o,d,w,u);this.canvasBoundsContainer=a;const b=r.mainCanvas.parentElement;if(b===null)throw new Error("Couldn't get main canvas parent");const c=new bt(o,b);this.canvasInputListener=c,this.chartComponents.push(this.canvasInputListener);const g=new Tt(o,r.hitTestCanvas,c,a,i,e,this.canvasModels,r.chartResizer);this.hitTestCanvasModel=g;const P=new L(g);i.addDrawer(P,T.HIT_TEST_CLEAR);const H=new X(o);this.canvasAnimation=H;const p=new Et(e,()=>a.getBounds(x.CHART),H);this.scaleModel=p;const S=f(o,r.backgroundCanvas,e,i,this.canvasModels,r.chartResizer);this.cursorHandler=new J(r.canvasArea,c,a,e,g),this.chartComponents.push(this.cursorHandler),this.crossEventProducer=new Mt(o,c,a),this.chartComponents.push(this.crossEventProducer);const v=new at(o,p,a,e,H,c,b);this.chartPanComponent=v,this.chartComponents.push(v),this.userInputListenerComponents.push(v.chartAreaPanHandler);const l=new ht(this.userInputListenerComponents,o,p,a,e,H,c,i,this.dataSeriesCanvasModel,this.cursorHandler,this.crossEventProducer,v,d);this.paneManager=l,this.chartComponents.push(l),this.chartModel=new tt(l,o,this.dataSeriesCanvasModel,e,p,w,b,a,u);const A=new $(this.chartModel,this.dataSeriesCanvasModel,e,p,a,i,g,c,S,v,l,this.cursorHandler);this.chartComponents.push(A),this.chartComponent=A;const m=this.chartComponent.chartModel;this.chartModel=m,this.canvasBoundsContainer.setMainCandleSeries(this.chartModel.mainCandleSeries),g.addSubscriber(l.hitTestContoller),this.xAxisComponent=new dt(o,e,d,A,p,a,c,u,this.drawingManager,C,v,this.cursorHandler,S),this.chartComponents.push(this.xAxisComponent),this.userInputListenerComponents.push(this.xAxisComponent);const z=new L(d);i.addDrawer(z,T.MAIN_CLEAR);const _=new gt(b,m,c,e);this.chartComponents.push(_),this.watermarkComponent=new pt(l,m,o,e,a,E,i),this.chartComponents.push(this.watermarkComponent);const U=f(o,r.crossToolCanvas,e,i,this.canvasModels,r.chartResizer);this.highlightsComponent=new it(o,e,m,d,a,i),this.chartComponents.push(this.highlightsComponent),e.useUTCTimeOverride&&e.dateFormatter&&!e.dateFormatter.utcTimeOverride&&(e.dateFormatter.utcTimeOverride=this.createUTCTimeOverrideConfig(m)),this.navigationMapComponent=new rt(o,m,d,e,c,a,i,w,v,this.cursorHandler),this.chartComponents.push(this.navigationMapComponent),this.userInputListenerComponents.push(this.navigationMapComponent.navigationMapMoveHandler);const V=new ot(e,this.dataSeriesCanvasModel,m,a,i);this.chartComponents.push(V),this.yAxisComponent=new lt(o,e,d,F,m,p,this.canvasInputListener,a,this.drawingManager,v,l,this.cursorHandler),this.chartComponents.push(this.yAxisComponent),this.userInputListenerComponents.push(this.yAxisComponent.yAxisScaleHandler),this.volumesComponent=new mt(this.dataSeriesCanvasModel,A,p,a,i,e,l),this.chartComponents.push(this.volumesComponent);const O=new nt(d,p,e,T.GRID,i,()=>this.canvasBoundsContainer.getBounds(x.ALL_PANES),()=>this.canvasBoundsContainer.getBounds(x.PANE_UUID(j)),()=>this.xAxisComponent.xAxisLabelsGenerator.labels,()=>this.yAxisComponent.yAxisModel.yAxisBaseLabelsModel.labels,()=>this.chartModel.toY(this.chartModel.getBaseLine()),()=>e.components.grid.visible);this.chartComponents.push(O),this.crossToolComponent=new et(o,e,m,U,a,c,i,w,C,l),this.chartComponents.push(this.crossToolComponent),this.hoverProducer=new wt(this.crossEventProducer,o,p,e,m,c,()=>this.crossToolComponent.model.xFormatter,this.canvasBoundsContainer,this.paneManager),this.chartComponents.push(this.hoverProducer);const k=f(o,r.snapshotCanvas,e,i,this.canvasModels,r.chartResizer),y=new ct(this.elements,k);this.snapshotComponent=y,this.chartComponents.push(y);const R=new st(e,E,g,m,a,i,w,this.cursorHandler,S);this.eventsComponent=R,this.chartComponents.push(R),this.chartComponents.forEach(G=>G.activate()),this.enableUserControls(),i.reorderDrawers(e.drawingOrder),this.clearer=At(this.components)}createUTCTimeOverrideConfig(t){const n=new RegExp("HH|H|mm|m|s|ss|sss|SSS");return{pattern:"MM/dd/YY",test:s=>n.test(s)&&(t.getPeriod()||0)>=86400}}static mergeConfig(t,n){for(const s in n)s in t?typeof t[s]=="object"&&B.mergeConfig(t[s],n[s]):t[s]=n[s];return t}getConfig(){return this.config}setRtl(t){this.config.rtl=t,this.bus.fire(vt)}setChartType(t){this.chartComponent.setChartType(t)}disableUserControls(){this.userInputListenerComponents.forEach(t=>t.deactivate()),this.hitTestCanvasModel.disableUserControls()}enableUserControls(){this.userInputListenerComponents.forEach(t=>t.activate()),this.hitTestCanvasModel.enableUserControls()}setGridConfig(t){var n,s,h,e,M;const C=this.config.components.grid;C.visible=(n=t.visible)!==null&&n!==void 0?n:!1,C.dash=(s=t.dash)!==null&&s!==void 0?s:[0,0],C.width=(h=t.width)!==null&&h!==void 0?h:1,C.color=(e=t.color)!==null&&e!==void 0?e:"#FFFFFF",this.config.colors.chartAreaTheme.gridColor=(M=t.color)!==null&&M!==void 0?M:"#FFFFFF",this.redraw()}setGridVisible(t){this.config.components&&this.config.components.grid&&(this.config.components.grid.visible=t,this.redraw())}setGridVertical(t){this.config.components.grid.vertical=t,this.redraw()}setGridHorizontal(t){this.config.components.grid.horizontal=t,this.redraw()}deactivate(){this.clearer(),this.disableUserControls(),this.chartComponents.forEach(t=>t.deactivate())}redraw(){this.bus.fireDraw()}getOffsets(){return this.config.components&&this.config.components.offsets}showSeparateVolumes(t=!1){this.volumesComponent&&(this.volumesComponent.setShowVolumesSeparatly(t),this.cursorHandler.toggleVolumesMode(t),this.yAxisComponent.yAxisModel.updateYAxisWidth())}setAutoScale(t=!0){this.scaleModel.autoScale(t)}setShowCandleBorders(t=!0){this.config.components&&this.config.components.chart&&(this.config.components.chart.showCandlesBorder=t,this.redraw())}valueToY(t){return this.chartModel.toY(t)}setHighLowVisible(t=!0){this.config.components&&this.config.components.highLow&&(this.config.components.highLow.visible=t,this.redraw())}setCrossToolVisible(t="cross-and-labels"){this.config.components&&this.config.components.crossTool&&(this.config.components.crossTool.type=t,this.redraw())}setHighlightsVisible(t=!0){var n;!((n=this.config.components)===null||n===void 0)&&n.highlights&&(this.config.components.highlights.visible=t,this.redraw())}setHighlightsData(t){this.highlightsComponent.setHighlights(t)}setColors(t){Lt(this.config.colors,t,{addIfMissing:!0,overrideExisting:!0}),this.redraw()}addMouseMoveOnChartElementHandler(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=this.canvasInputListener.observeMouseMove(s).subscribe(n);return()=>h.unsubscribe()}addMouseEnterOnChartElementHandler(t,n,s=!1){const h=this.canvasBoundsContainer.getBoundsHitTest(t),e=this.canvasInputListener.observeMouseEnter(h,s).subscribe(n);return()=>e.unsubscribe()}addClickOnChartElementHandler(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=this.canvasInputListener.observeClick(s).subscribe(n);return()=>h.unsubscribe()}addDragEventsListener(t,n){const s=this.canvasBoundsContainer.getBoundsHitTest(t),h=Y(this.canvasInputListener.observeYDrag(s),this.canvasInputListener.observeXDrag(s)).subscribe(n);return()=>h.unsubscribe()}destroy(){this.bus.setMuted(!0),this.chartComponents.forEach(t=>t.disable()),this.parentElement.childNodes.forEach(t=>t.remove()),this.parentElement.style.width="",this.parentElement.style.height=""}registerComponent(t,n){const s=t(this);this.components.push(s),n&&n(s),s.activate()}registerPaneFormatters(t,n){var s;(s=this.paneManager.paneComponents[t])===null||s===void 0||s.setPaneValueFormatters(n)}}
