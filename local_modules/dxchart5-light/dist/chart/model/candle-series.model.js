/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{Subject as C}from"rxjs";import{getDefaultConfig as f}from"../chart.config";import{defaultCandleTransformer as v}from"../components/chart/candle-transformer.functions";import{calculateCandleWidth as g}from"../components/chart/candle-width-calculator.functions";import{merge as w}from"../utils/merge.utils";import{BASIC_CANDLE_WIDTH as u,nameDirection as D}from"./candle.model";import{calculateCandlesHighLow as y,createCandleSeriesHighLowProvider as L}from"./candle-series-high-low.provider";import{DataSeriesModel as M}from"./data-series.model";import{getDefaultHighLowWithIndex as S}from"./scale.model";import{PriceIncrementsUtils as V}from"../utils/price-increments.utils";import{lastOf as x}from"../utils/array.utils";const I=f().colors;export class CandleSeriesModel extends M{get dataPoints(){return super.dataPoints}set dataPoints(e){super.dataPoints=e,this.applyPriceMovement()}get instrument(){return this._instrument}set instrument(e){var t;this._instrument=e,this.pricePrecisions=V.computePrecisions((t=e.priceIncrements)!==null&&t!==void 0?t:[.01])}constructor(e,t,i,a,s,r,n,o=I){super(e,t),this.eventBus=i,this.candlesTransformersByChartType=r,this.candleWidthByChartType=n,this.colors=o,this.zippedHighLow=S(),this.lastPriceMovement="none",this.lastVisualCandleChangedSubject=new C,this.meanCandleWidth=u,this._instrument=s,this.instrument=s,this.highLowProvider=L(this),this.scaleModel=a,this.name=s.symbol}recalculateDataViewportIndexes(e=this.scaleModel.xStart,t=this.scaleModel.xEnd){super.recalculateDataViewportIndexes(e,t),this.recalculateZippedHighLow(),this.eventBus.fireDraw()}applyPriceMovement(){const e=x(this.dataPoints);e&&(this.lastPriceMovement=D(e.open,e.close))}recalculateVisualPoints(){super.recalculateVisualPoints(),this.recalculateMeanCandleWidth(this.visualPoints)}recalculateZippedHighLow(){return this.zippedHighLow=y(this.visualPoints.slice(this.dataIdxStart,this.dataIdxEnd))}updateCurrentPrice(e){this.previousPrice=this.currentPrice||e,this.currentPrice=e,this.currentPrice!==this.previousPrice&&(this.lastPriceMovement=this.currentPrice>this.previousPrice?"up":"down")}updateCandleSeriesColors(e){this.colors=w(e,this.colors),this.recalculateVisualPoints()}observeLastVisualCandleChanged(){return this.lastVisualCandleChangedSubject.asObservable()}doDeactivate(){super.doDeactivate()}toVisualPoints(e,t=0){var i,a;if(e.length===0)return[];const s=this.config.type,r=[];let n=t;const o=(i=this.candleWidthByChartType[s])!==null&&i!==void 0?i:g;for(let l=0;l<e.length;l++){const d=e[l],p=e[l-1],c=o(d),m=n+c/2,P=(a=this.candlesTransformersByChartType[s])!==null&&a!==void 0?a:v;r.push(P(d,{x:m,width:c,prevCandle:p,activeCandle:this.activeCandle})),n+=c}return r}recalculateMeanCandleWidth(e){e.length!==0?this.meanCandleWidth=e.reduce((t,i)=>t+i.width,0)/e.length:this.meanCandleWidth=u}setActiveCandle(e){this.activeCandle=e,this.recalculateVisualPoints()}clearData(){this.dataPoints=[],this.clearVisualCandles(),this.clearPrices()}clearPrices(){this.previousPrice=void 0,this.currentPrice=void 0,this.lastPriceMovement="none"}clearVisualCandles(){this.visualPoints=[]}}export function isLinked(h){switch(h){case"line":case"area":return!0;default:return!1}}
