/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{merge as k,Subject as v}from"rxjs";import{map as S,throttleTime as f}from"rxjs/operators";import{CanvasElement as E}from"../canvas/canvas-bounds-container";import{CanvasModel as x,initCanvasWithConfig as H}from"./canvas.model";import{animationFrameId as T}from"../utils/perfomance/request-animation-frame-throttle.utils";const C=317;export const HIT_TEST_ID_RANGE={DRAWINGS:[0,199],NEWS:[200,299],DATA_SERIES:[300,2999],EVENTS:[3e3,4e3]};export class HitTestCanvasModel extends x{constructor(e,s,r,o,u,n,a,i){super(e,s,u,a,i,{willReadFrequently:!0,desynchronized:!0}),this.canvasInputListener=r,this.canvasBoundsContainer=o,this.hitTestSubscribers=[],this.eventsSubscriptions=[],this.hoverSubject=new v,this.touchStartSubject=new v,this.dblClickSubject=new v,this.rightClickSubject=new v,this.curImgData=new Uint8ClampedArray(4),this.prevAnimationFrameId=-1,H(this,n),s.style.visibility="hidden",this.enableUserControls()}enableUserControls(){if(this.eventsSubscriptions.length===0){const e=this.canvasBoundsContainer.getBoundsHitTest(E.ALL_PANES),s=this.canvasInputListener.observeMouseMove().pipe(f(100,void 0,{trailing:!0})).subscribe(i=>this.eventHandler(i,"hover")),r=this.canvasInputListener.observeTouchStart().pipe(S(()=>this.canvasInputListener.currentPoint)).subscribe(i=>this.eventHandler(i,"touchstart")),o=k(this.canvasInputListener.observeMouseDown(e),this.canvasInputListener.observeTouchStart().pipe(S(()=>this.canvasInputListener.currentPoint))).subscribe(i=>this.eventHandler(i,"mousedown")),u=this.canvasInputListener.observeDbClick(e).subscribe(i=>this.eventHandler(i,"dblclick")),n=this.canvasInputListener.observeContextMenu(e).pipe(S(()=>Object.assign({},this.canvasInputListener.currentPoint))).subscribe(i=>{this.eventHandler(i,"contextmenu")}),a=this.canvasInputListener.observeWheel(e).subscribe(i=>setTimeout(()=>this.eventHandler(i,"zoom"),0));this.eventsSubscriptions.push(s,o,u,n,a,r)}}disableUserControls(){this.eventsSubscriptions.forEach(e=>e.unsubscribe()),this.eventsSubscriptions=[]}addSubscriber(e){this.hitTestSubscribers.push(e)}removeSubscriber(e){this.hitTestSubscribers=this.hitTestSubscribers.filter(s=>s===e)}idToColor(e){const s=(e*C).toString(16);return"#000000".substr(0,7-s.length)+s}colorToId(e){return e/C}observeHoverOnElement(){return this.hoverSubject.asObservable()}observeTouchStartOnElement(){return this.touchStartSubject.asObservable()}observeDblClickOnElement(){return this.dblClickSubject.asObservable()}observeRightClickOnElement(){return this.rightClickSubject.asObservable()}getPixel(e,s){const r=window.devicePixelRatio;return this.prevAnimationFrameId!==T&&(this.curImgData=this.ctx.getImageData(e*r,s*r,1,1).data,this.prevAnimationFrameId=T),this.curImgData}resolveCursor(e){var s;if(!this.hitTestSubscribers.some(i=>i.resolveCursor!==void 0))return;const r=this.getPixel(e.x,e.y),o=this.colorToId(r[0]*65536+r[1]*256+r[2]),u=Number(o),[n]=I(this.hitTestSubscribers,u),a=n==null?void 0:n.lookup(o);return(s=n==null?void 0:n.resolveCursor)===null||s===void 0?void 0:s.call(n,e,a)}eventHandler(e,s){var r,o,u,n,a,i;const d=this.getPixel(e.x,e.y),p=this.colorToId(d[0]*65536+d[1]*256+d[2]),g=Number(p),[t,b]=I(this.hitTestSubscribers,g),c=t==null?void 0:t.lookup(p),h={point:e,model:c};switch(s){case"mousedown":c&&((r=t==null?void 0:t.onMouseDown)===null||r===void 0||r.call(t,c,e)),b.forEach(l=>l.onMouseDown&&l.onMouseDown(null,e));break;case"hover":c&&((o=t==null?void 0:t.onHover)===null||o===void 0||o.call(t,c,e)),b.forEach(l=>l.onHover&&l.onHover(null,e)),this.hoverSubject.next(h);break;case"touchstart":c&&((u=t==null?void 0:t.onTouchStart)===null||u===void 0||u.call(t,c,e)),b.forEach(l=>l.onTouchStart&&l.onTouchStart(null,e)),this.touchStartSubject.next(h);break;case"dblclick":c&&((n=t==null?void 0:t.onDblClick)===null||n===void 0||n.call(t,c,e)),this.dblClickSubject.next(h);break;case"contextmenu":c&&((a=t==null?void 0:t.onRightClick)===null||a===void 0||a.call(t,c,e)),this.rightClickSubject.next(h);break;case"zoom":c&&((i=t==null?void 0:t.onZoom)===null||i===void 0||i.call(t,c,e)),b.forEach(l=>l.onZoom&&l.onZoom(null,e));break;default:break}}}const I=(m,e)=>{let s;const r=[];return m.forEach(o=>{const[u,n]=o.getIdRange();e>=u&&e<=n?s=o:r.push(o)}),[s,r]};
