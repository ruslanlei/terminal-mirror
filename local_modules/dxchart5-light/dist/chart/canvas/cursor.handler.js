/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{Subject as a}from"rxjs";import{distinctUntilChanged as h,throttleTime as u}from"rxjs/operators";import{ChartBaseElement as c}from"../model/chart-base-element";import{SeparateVolumesComponent as i}from"../components/volumes/separate-volumes.component";import{CanvasBoundsContainer as C,CanvasElement as n}from"./canvas-bounds-container";export class CursorHandler extends c{constructor(e,t,s,r,o){super(),this.element=e,this.canvasInputListener=t,this.canvasBoundsContainer=s,this.chartConfig=r,this.hitTestCanvasModel=o,this.normalLayer=new Map,this.extensionLayer=new Map,this.cursorChangedSubject=new a}doActivate(){super.doActivate(),this.canvasInputListener.observeMouseMoveNoDrag().pipe(u(100,void 0,{trailing:!0})).subscribe(e=>{const t=this.hitTestCanvasModel.resolveCursor(e);if(t!==void 0){this.updateCursor(t);return}e&&(this.normalLayer.forEach(s=>{s.hitTest(e.x,e.y)&&this.updateCursor(s.cursor)}),this.extensionLayer.forEach(s=>{s.hitTest(e.x,e.y)&&this.updateCursor(s.cursor)}))})}setCursorTypeForBounds(e,t,s,r=0){const o=C.hitTestOf(t,{extensionY:r});r?this.extensionLayer.set(e,{cursor:s,hitTest:o}):this.normalLayer.set(e,{cursor:s,hitTest:o})}addCursorForCanvasEl(e,t,s){this.observeCursorType(e,t,s)}removeCursorForCanvasEl(e){this.normalLayer.delete(e),this.extensionLayer.delete(e)}observeCursorChanged(){return this.cursorChangedSubject.pipe(h())}observeCursorType(e,t,s){const r=s?this.canvasBoundsContainer.getBoundsHitTest(e,{extensionY:s}):this.canvasBoundsContainer.getBoundsHitTest(e);s?this.extensionLayer.set(e,{cursor:t,hitTest:r}):this.normalLayer.set(e,{cursor:t,hitTest:r})}updateCursor(e){this.element.style.cursor!==e&&(this.element.style.cursor=e,this.cursorChangedSubject.next(e))}toggleVolumesMode(e){const t=n.PANE_UUID(i.UUID),s=n.PANE_UUID_RESIZER(i.UUID);e?(this.observeCursorType(t,this.chartConfig.components.chart.cursor),this.observeCursorType(s,this.chartConfig.components.paneResizer.cursor,this.chartConfig.components.paneResizer.dragZone)):(this.normalLayer.delete(t),this.extensionLayer.delete(s))}}
