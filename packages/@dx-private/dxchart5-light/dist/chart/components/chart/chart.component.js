/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{CHART_UUID as l,CanvasElement as c}from"../../canvas/canvas-bounds-container";import{ChartBaseElement as g}from"../../model/chart-base-element";import{BackgroundDrawer as T}from"../../drawers/chart-background.drawer";import{AreaDrawer as M}from"../../drawers/chart-type-drawers/area.drawer";import{BarDrawer as v}from"../../drawers/chart-type-drawers/bar.drawer";import{BaselineDrawer as I}from"../../drawers/chart-type-drawers/baseline.drawer";import{CandleDrawer as y}from"../../drawers/chart-type-drawers/candle.drawer";import{HistogramDrawer as E}from"../../drawers/chart-type-drawers/histogram.drawer";import{LineDrawer as A}from"../../drawers/chart-type-drawers/line.drawer";import{ScatterPlotDrawer as b}from"../../drawers/chart-type-drawers/scatter-plot.drawer";import{CandleSeriesWrapper as P}from"../../drawers/data-series-drawers/candle-series-wrapper";import{ColorCandleDrawer as _}from"../../drawers/data-series-drawers/color-candle.drawer";import{DifferenceCloudDrawer as L}from"../../drawers/data-series-drawers/difference-cloud.drawer";import{HistogramDrawer as B}from"../../drawers/data-series-drawers/histogram.drawer";import{LinearDrawer as N}from"../../drawers/data-series-drawers/linear.drawer";import{PointsDrawer as R}from"../../drawers/data-series-drawers/points.drawer";import{TextDrawer as O}from"../../drawers/data-series-drawers/text.drawer";import{TriangleDrawer as x}from"../../drawers/data-series-drawers/triangle.drawer";import{DataSeriesDrawer as U}from"../../drawers/data-series.drawer";import{HIT_TEST_PREFIX as F}from"../../drawers/drawing-manager";import{HTDataSeriesDrawer as H}from"../../drawers/ht-data-series.drawer";import{BaselineModel as X}from"../../model/baseline.model";import{keys as k}from"../../utils/object.utils";import{PriceIncrementsUtils as m}from"../../utils/price-increments.utils";import{defaultCandleTransformer as V,hollowCandleTransformer as W,trendCandleTransformer as G}from"./candle-transformer.functions";import{deleteCandlesIndex as j}from"./candle.functions";export class ChartInstrument{constructor(){this.symbol="MOCK",this.priceIncrements=[.01]}}export class ChartComponent extends g{constructor(e,r,t,a,i,s,n,D,C,w,d,h){super(),this.chartModel=e,this.canvasModel=r,this.config=t,this.scaleModel=a,this.canvasBoundsContainer=i,this.drawingManager=s,this.hitTestCanvasModel=n,this.canvasInputListener=D,this.dataSeriesDrawers={},this.strToBarType=f=>{var o;return(o=this.barTypeValues.find(S=>S===f))!==null&&o!==void 0?o:"candle"},this.addChildEntity(this.chartModel),this.registerDefaultCandlesTransformers(),this.baselineModel=new X(this.chartModel,w,this.canvasModel,this.canvasInputListener,this.config,this.canvasBoundsContainer,h),this.addChildEntity(this.baselineModel);const u=new H(this.dataSeriesDrawers,this.hitTestCanvasModel,d);this.drawingManager.addDrawerBefore(u,F+"DATA_SERIES","HIT_TEST_EVENTS"),this.dataSeriesDrawer=new U(d,r,this.dataSeriesDrawers),this.drawingManager.addDrawer(this.dataSeriesDrawer,"DATA_SERIES"),this.registerDefaultDataSeriesDrawers(),this.backgroundDrawer=new T(C,this.config),s.addDrawer(this.backgroundDrawer,"MAIN_BACKGROUND"),h.addCursorForCanvasEl(c.PANE_UUID(l),t.components.chart.cursor)}doActivate(){super.doActivate()}registerDefaultCandlesTransformers(){this.registerCandlesTransformer("candle",V),this.registerCandlesTransformer("trend",G),this.registerCandlesTransformer("hollow",W)}get barTypeValues(){return k(this.dataSeriesDrawers)}registerCandlesTransformer(e,r){this.chartModel.registerCandlesTransformer(e,r)}registerLastCandleLabelHandler(e,r){this.chartModel.registerLastCandleLabelHandler(e,r)}registerCandlesWidthCalculator(e,r){this.chartModel.registerCandlesWidthCalculator(e,r)}registerDefaultDataSeriesDrawers(){const e=new y(this.config.components.chart);this.registerDataSeriesTypeDrawer("candle",e),this.registerDataSeriesTypeDrawer("trend",e),this.registerDataSeriesTypeDrawer("hollow",e),this.registerDataSeriesTypeDrawer("bar",new v(this.config.components.chart)),this.registerDataSeriesTypeDrawer("line",new A(this.config.components.chart)),this.registerDataSeriesTypeDrawer("scatterPlot",new b(this.config.colors.scatterPlot)),this.registerDataSeriesTypeDrawer("area",new M(this.config.components.chart)),this.registerDataSeriesTypeDrawer("baseline",new I(this.baselineModel,this.canvasBoundsContainer)),this.registerDataSeriesTypeDrawer("histogram",new E(this.config.components.chart.histogram));const r=()=>this.canvasBoundsContainer.getBounds(c.PANE_UUID(l));this.registerDataSeriesTypeDrawer("LINEAR",new N),this.registerDataSeriesTypeDrawer("HISTOGRAM",new B),this.registerDataSeriesTypeDrawer("POINTS",new R),this.registerDataSeriesTypeDrawer("COLOR_CANDLE",new P(new _(this.chartModel),this.config,r)),this.registerDataSeriesTypeDrawer("TEXT",new O(this.config)),this.registerDataSeriesTypeDrawer("TRIANGLE",new x),this.registerDataSeriesTypeDrawer("DIFFERENCE",new L)}setChartType(e){this.config.components.chart.type=e,this.chartModel.rememberCurrentTimeframe(),this.chartModel.mainCandleSeries.setType(e),this.chartModel.mainCandleSeries.updateCandleSeriesColors(Object.assign({},this.config.colors)),this.chartModel.mainCandleSeries.recalculateVisualPoints(),this.chartModel.chartTypeChanged.next(e)}resetChartScale(){this.chartModel.doBasicScale()}setTimestampRange(e,r){return this.chartModel.setTimestampRange(e,r)}setXScale(e,r){return this.scaleModel.setXScale(e,r)}setShowWicks(e){this.config.components.chart.showWicks=e,this.canvasModel.fireDraw()}setMainSeries(e){var r;const t=(r=e.instrument)!==null&&r!==void 0?r:this.chartModel.mainCandleSeries.instrument;this.chartModel.mainCandleSeries.instrument=t,this.chartModel.setAllSeries({candles:e.candles,instrument:t},this.chartModel.getSecondarySeries().map(a=>{var i;const s=(i=a.instrument)!==null&&i!==void 0?i:this.chartModel.mainCandleSeries.instrument,n=a.dataPoints;return j(n),{candles:n,instrument:s}})),this.updatePriceIncrementsIfNeeded(t)}setSecondarySeries(e){var r;const t=(r=e.instrument)!==null&&r!==void 0?r:this.chartModel.mainCandleSeries.instrument,a=this.chartModel.setSecondaryCandleSeries(e.candles,t);if(this.updatePriceIncrementsIfNeeded(t),a)return a}setAllSeries(e,r=[]){var t;const a=(t=e.instrument)!==null&&t!==void 0?t:this.chartModel.mainCandleSeries.instrument;this.updatePriceIncrementsIfNeeded(a),r.forEach(i=>{var s;const n=(s=i.instrument)!==null&&s!==void 0?s:this.chartModel.mainCandleSeries.instrument;this.updatePriceIncrementsIfNeeded(n)}),this.chartModel.setAllSeries(e,r)}toXFromCandleIndex(e){return this.chartModel.toX(e)}toXFromTimestamp(e){return this.chartModel.candleFromTimestamp(e).xCenter(this.chartModel.scaleModel)}toY(e){return this.chartModel.toY(e)}updateAllSeries(e,r){this.chartModel.updateAllSeries(e,r),this.canvasModel.fireDraw()}removeDataFrom(e){this.chartModel.removeDataFrom(e)}removeSecondarySeries(e){this.chartModel.removeSecondaryCandleSeries(e)}prependCandles(e,r){this.chartModel.prependCandles(e,r)}addLastCandle(e,r){this.chartModel.addLastCandle(e,r)}updateLastCandle(e,r){this.chartModel.updateLastCandle(e,r)}updateCandles(e,r){this.chartModel.updateCandles(e,r)}setOffsets(e){this.chartModel.setOffsets(e)}getDataSeriesDrawer(e){return this.dataSeriesDrawers[e]}registerDataSeriesTypeDrawer(e,r){this.dataSeriesDrawers[e]=r}updatePriceIncrementsIfNeeded(e){(!e.priceIncrements||!m.validatePriceIncrementsOrPrecisions(e.priceIncrements))&&(e.priceIncrements=[m.autoDetectIncrementOfValueRange(this.scaleModel.yEnd-this.scaleModel.yStart)])}observeOffsetsChanged(){return this.chartModel.offsetsChanged}observeChartTypeChanged(){return this.chartModel.chartTypeChanged}observeCandlesChanged(){return this.chartModel.observeCandlesChanged()}observeCandlesUpdated(){return this.chartModel.candlesUpdatedSubject}}
