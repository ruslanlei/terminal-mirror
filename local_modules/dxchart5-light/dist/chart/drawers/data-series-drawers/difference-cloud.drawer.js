/*
 * Copyright (C) 2002 - 2023 Devexperts LLC
 * This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
 * If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import{setLineWidth as C}from"../data-series.drawer";import{buildLinePath as b}from"./data-series-drawers.utils";import{firstOf as y,lastOf as D}from"../../utils/utils-index";import{toRGBA as m}from"../../utils";export class DifferenceCloudDrawer{constructor(){}draw(o,r,i,f){i.config.visible&&(r.forEach((e,l)=>{var s;const n=i.getPaintConfig(l);C(o,n.lineWidth,i,f,n.hoveredLineWidth);const a=(s=f.singleColor)!==null&&s!==void 0?s:n.color;o.strokeStyle=a,this.drawLine(o,e,i.view)}),i.linkedDataSeriesModels.forEach((e,l)=>{if(isDifferenceTool(e.config.type)&&isDifferenceTool(i.config.type)&&e.config.visible){const s=[],n=i,a=n.getSeriesInViewport(n.scaleModel.xStart-1,n.scaleModel.xEnd+1),c=e.getSeriesInViewport(e.scaleModel.xStart-1,e.scaleModel.xEnd+1);a.forEach((h,t)=>{const g=Math.min(h.length,c[t].length);for(let P=0;P<g;P++){const p=[Object.assign({},h[P]),Object.assign({},c[t][P])];s.push({diffPoints:p})}const v=n.getPaintConfig(t).color,E=e.getPaintConfig(l).color;this.drawDifference(o,v,E,s,n,e,f)})}}))}drawLine(o,r,i){o.beginPath(),b(r,o,i),o.stroke()}drawDifference(o,r,i,f,e,l,s){const[n,a]=[[],[]];f.forEach(t=>{const[g,v]=t.diffPoints;n.push(g),a.push(v)});const c=d(n,e.view),h=d(a,l.view);this.fillCloud(o,i,c,h,s),this.fillCloud(o,r,h,c,s)}fillCloud(o,r,i,f,e){var l,s,n,a;o.save(),o.beginPath();const c=(s=(l=y(i))===null||l===void 0?void 0:l.x)!==null&&s!==void 0?s:0,h=(a=(n=D(i))===null||n===void 0?void 0:n.x)!==null&&a!==void 0?a:0;o.lineTo(c,0),i.forEach(t=>{o.lineTo(t.x,t.y)}),o.lineTo(h,0),o.closePath(),o.clip(),o.beginPath(),i.forEach((t,g)=>{g===0?o.moveTo(t.x,t.y):o.lineTo(t.x,t.y)}),f.slice().reverse().forEach(t=>{o.lineTo(t.x,t.y)}),o.closePath(),o.fillStyle=e.singleColor?e.singleColor:m(r||"#383838",.3),o.fill(),o.restore()}}const d=(u,o)=>u.map(r=>{const{centerUnit:i,close:f}=r,e=o.toX(i),l=o.toY(f);return{x:e,y:l}});export const isDifferenceTool=u=>u==="DIFFERENCE";
